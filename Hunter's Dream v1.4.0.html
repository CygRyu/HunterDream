<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter's Dream - Sleep Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=EB+Garamond&display=swap');

        :root {
            --primary-color: #a5181d;
            --secondary-color: #6e1212;
            --background-dark: #0f0f11;
            --background-light: #f5f5f5;
            --text-dark: #d3cfc7;
            --text-light: #2d2d2d;
            --border-dark: #3c3b3b;
            --border-light: #d1d1d1;
            --phase-rem: #8a0303;
            --phase-deep: #3f0101;
            --phase-light: #b30404;
            --phase-awake: #e98a17;
        }

        .dark {
            --bg-color: var(--background-dark);
            --text-color: var(--text-dark);
            --border-color: var(--border-dark);
        }

        body:not(.dark) {
            --bg-color: var(--background-light);
            --text-color: var(--text-light);
            --border-color: var(--border-light);
        }

        body {
            font-family: 'EB Garamond', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="none"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(100,100,100,0.05)" stroke-width="0.5"/></svg>');
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
        }

        .blood-btn {
            background-color: var(--primary-color);
            transition: background-color 0.3s;
        }

        .blood-btn:hover {
            background-color: var(--secondary-color);
        }

        .blood-btn:disabled {
            background-color: #723434;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .danger-btn {
            background-color: #6b0000;
            transition: background-color 0.3s;
        }

        .danger-btn:hover {
            background-color: #500000;
        }

        .secondary-btn {
            background-color: #333;
            transition: background-color 0.3s;
        }

        .secondary-btn:hover {
            background-color: #444;
        }

        .card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .tab {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        input, select, textarea {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .gothic-border {
            position: relative;
            overflow: hidden;
        }

        .gothic-border::before, .gothic-border::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--primary-color);
            border-style: solid;
        }

        .gothic-border::before {
            top: 0;
            left: 0;
            border-width: 2px 0 0 2px;
        }

        .gothic-border::after {
            bottom: 0;
            right: 0;
            border-width: 0 2px 2px 0;
        }

        .blood-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23a5181d" d="M12,2c-5.33,4.55-8,8.48-8,11.8c0,4.98,3.8,8.2,8,8.2s8-3.22,8-8.2C20,10.48,17.33,6.55,12,2z"/></svg>');
            background-repeat: no-repeat;
            background-size: contain;
        }

        .rune {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            font-family: 'Cinzel', serif;
            margin: 0 4px;
            transition: all 0.3s;
            opacity: 0.6;
            filter: grayscale(100%);
            position: relative;
        }

        .rune.unlocked {
            opacity: 1;
            filter: grayscale(0%);
            box-shadow: 0 0 10px rgba(165, 24, 29, 0.7);
        }

        .rune-level {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background-color: var(--primary-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: white;
            font-weight: bold;
        }

        .hunter-rank {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        /* Custom range input styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            margin-top: -10px;
        }

        input[type=range]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--border-color);
            border-radius: 2px;
        }

        input[type=range]::-moz-range-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--border-color);
            border-radius: 2px;
        }

        #bossCard {
            background-image: linear-gradient(to right, rgba(15, 15, 17, 0.9), rgba(15, 15, 17, 0.7)), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24"><path fill="%23641e17" d="M11.22 16.82L9.89 18.15Q9.525 18.5 9 18.5Q8.475 18.5 8.1 18.15Q7.725 17.8 7.725 17.275Q7.725 16.75 8.1 16.375L9.43 15.05Q8.825 14.85 8.3 14.613Q7.775 14.375 7.35 14.075Q6.925 13.775 6.613 13.425Q6.3 13.075 6.15 12.675L4.55 14.25Q4.2 14.6 3.675 14.6Q3.15 14.6 2.775 14.25Q2.425 13.9 2.425 13.375Q2.425 12.85 2.8 12.5L4.375 10.9Q3.975 10.75 3.625 10.438Q3.275 10.125 2.975 9.7Q2.675 9.275 2.438 8.75Q2.2 8.225 2 7.625L0.675 8.925Q0.3 9.3 0 8.925Q-0.3 8.55 0.05 8.15L2.625 5.575Q3.275 4.925 4.15 4.925Q5.025 4.925 5.675 5.575L6.775 6.675L11.225 2.225Q11.8 1.65 12.688 1.65Q13.575 1.65 14.15 2.225L17.375 5.425Q17.95 6 17.95 6.887Q17.95 7.775 17.375 8.35L12.925 12.825L14.025 13.925Q14.675 14.575 14.675 15.45Q14.675 16.325 14.025 16.975L11.85 19.15Q11.475 19.525 11.1 19.15Q10.725 18.775 11.1 18.4L12.375 17.075Q12.175 16.475 11.938 15.95Q11.7 15.425 11.4 15Q11.1 14.575 10.75 14.262Q10.4 13.95 10 13.8L11.575 12.2Q11.925 11.85 11.925 11.325Q11.925 10.8 11.55 10.45Q11.2 10.1 10.675 10.1Q10.15 10.1 9.8 10.45L8.2 12.025Q8.05 11.625 7.738 11.275Q7.425 10.925 7 10.625Q6.575 10.325 6.05 10.088Q5.525 9.85 4.925 9.65L6.25 8.325Q6.625 7.95 6.25 7.575Q5.875 7.2 5.5 7.575L4.175 8.875Q3.975 8.275 3.738 7.75Q3.5 7.225 3.2 6.8Q2.9 6.375 2.55 6.062Q2.2 5.75 1.8 5.6L3.375 4Q3.725 3.65 3.725 3.125Q3.725 2.6 3.35 2.25Q3 1.9 2.475 1.9Q1.95 1.9 1.6 2.25L0 3.825Q-0.15 3.425 -0.462 3.075Q-0.775 2.725 -1.2 2.425Q-1.625 2.125 -2.15 1.887Q-2.675 1.65 -3.275 1.45L-1.95 0.125Q-1.575 -0.25 -1.95 -0.625Q-2.325 -1 -2.7 -0.625L-4 0.675Q-4.2 0.075 -4.438 -0.45Q-4.675 -0.975 -4.975 -1.4Q-5.275 -1.825 -5.625 -2.138Q-5.975 -2.45 -6.375 -2.6L-4.8 -4.175Q-4.45 -4.525 -4.45 -5.05Q-4.45 -5.575 -4.825 -5.925Q-5.175 -6.275 -5.7 -6.275Q-6.225 -6.275 -6.575 -5.925L-8.175 -4.35Q-8.325 -4.75 -8.638 -5.1Q-8.95 -5.45 -9.375 -5.75Q-9.8 -6.05 -10.325 -6.287Q-10.85 -6.525 -11.45 -6.725L-10.125 -8.05Q-9.75 -8.425 -10.125 -8.8Q-10.5 -9.175 -10.875 -8.8L-12.2 -7.475Q-12.4 -8.075 -12.638 -8.6Q-12.875 -9.125 -13.175 -9.55Q-13.475 -9.975 -13.825 -10.288Q-14.175 -10.6 -14.575 -10.75L-13 -12.325Q-12.65 -12.675 -12.65 -13.2Q-12.65 -13.725 -13.025 -14.075Q-13.375 -14.425 -13.9 -14.425Q-14.425 -14.425 -14.775 -14.075L-16.375 -12.5L-17.375 -12.5L-20.125 -15.25Q-20.5 -15.625 -20.5 -16.15Q-20.5 -16.675 -20.125 -17.05L-17.55 -19.625Q-17.175 -20 -17.55 -20.375Q-17.925 -20.75 -18.3 -20.375L-19.625 -19.05Q-19.825 -19.65 -20.063 -20.175Q-20.3 -20.7 -20.6 -21.125Q-20.9 -21.55 -21.25 -21.862Q-21.6 -22.175 -22 -22.325L-20.425 -23.9Q-20.075 -24.25 -20.075 -24.775Q-20.075 -25.3 -20.45 -25.65Q-20.8 -26 -21.325 -26Q-21.85 -26 -22.2 -25.65L-23.775 -24.075Q-23.925 -24.475 -24.238 -24.825Q-24.55 -25.175 -24.975 -25.475Q-25.4 -25.775 -25.925 -26.012Q-26.45 -26.25 -27.05 -26.45L-25.725 -27.775Q-25.35 -28.15 -25.725 -28.525Q-26.1 -28.9 -26.475 -28.525L-27.8 -27.2Q-28 -27.8 -28.238 -28.325Q-28.475 -28.85 -28.775 -29.275Q-29.075 -29.7 -29.425 -30.013Q-29.775 -30.325 -30.175 -30.475L-28.6 -32.05Q-28.25 -32.4 -28.25 -32.925Q-28.25 -33.45 -28.625 -33.8Q-28.975 -34.15 -29.5 -34.15Q-30.025 -34.15 -30.375 -33.8L-31.975 -32.225Q-32.125 -32.625 -32.438 -32.975Q-32.75 -33.325 -33.175 -33.625Q-33.6 -33.925 -34.125 -34.162Q-34.65 -34.4 -35.25 -34.6L-33.925 -35.925Q-33.55 -36.3 -33.925 -36.675Q-34.3 -37.05 -34.675 -36.675L-36 -35.35Q-36.2 -35.95 -36.438 -36.475Q-36.675 -37 -36.975 -37.425Q-37.275 -37.85 -37.625 -38.163Q-37.975 -38.475 -38.375 -38.625L-36.8 -40.2Q-36.45 -40.55 -36.45 -41.075Q-36.45 -41.6 -36.825 -41.95Q-37.175 -42.3 -37.7 -42.3Q-38.225 -42.3 -38.575 -41.95L-40.15 -40.375Q-40.3 -40.775 -40.613 -41.125Q-40.925 -41.475 -41.35 -41.775Q-41.775 -42.075 -42.3 -42.312Q-42.825 -42.55 -43.425 -42.75L-42.1 -44.075Q-41.725 -44.45 -42.1 -44.825Q-42.475 -45.2 -42.85 -44.825L-44.175 -43.5Q-44.375 -44.1 -44.613 -44.625Q-44.85 -45.15 -45.15 -45.575Q-45.45 -46 -45.8 -46.312Q-46.15 -46.625 -46.55 -46.775L-44.975 -48.35Q-44.625 -48.7 -44.625 -49.225Q-44.625 -49.75 -45 -50.1Q-45.35 -50.45 -45.875 -50.45Q-46.4 -50.45 -46.75 -50.1L-48.35 -48.525Q-48.5 -48.925 -48.812 -49.275Q-49.125 -49.625 -49.55 -49.925Q-49.975 -50.225 -50.5 -50.462Q-51.025 -50.7 -51.625 -50.9L-50.3 -52.225Q-49.925 -52.6 -50.3 -52.975Q-50.675 -53.35 -51.05 -52.975L-52.375 -51.65Q-52.575 -52.25 -52.812 -52.775Q-53.05 -53.3 -53.35 -53.725Q-53.65 -54.15 -54 -54.462Q-54.35 -54.775 -54.75 -54.925L-53.175 -56.5Q-52.825 -56.85 -52.825 -57.375Q-52.825 -57.9 -53.2 -58.25Q-53.55 -58.6 -54.075 -58.6Q-54.6 -58.6 -54.95 -58.25L-56.525 -56.675Q-56.675 -57.075 -56.988 -57.425Q-57.3 -57.775 -57.725 -58.075Q-58.15 -58.375 -58.675 -58.612Q-59.2 -58.85 -59.8 -59.05L-58.475 -60.375Q-58.1 -60.75 -58.475 -61.125Q-58.85 -61.5 -59.225 -61.125L-60.55 -59.8Q-60.75 -60.4 -60.988 -60.925Q-61.225 -61.45 -61.525 -61.875Q-61.825 -62.3 -62.175 -62.612Q-62.525 -62.925 -62.925 -63.075L-61.35 -64.65Q-61 -65 -61 -65.525Q-61 -66.05 -61.375 -66.4Q-61.725 -66.75 -62.25 -66.75Q-62.775 -66.75 -63.125 -66.4L-66.125 -63.4L-66.125 -60.4L-64.125 -58.4L-64.125 -55.4L-62.125 -53.4L-62.125 -50.4L-60.125 -48.4L-60.125 -45.4L-58.125 -43.4L-58.125 -40.4L-56.125 -38.4L-56.125 -35.4L-54.125 -33.4L-54.125 -30.4L-52.125 -28.4L-52.125 -25.4L-50.125 -23.4L-50.125 -20.4L-48.125 -18.4L-48.125 -15.4L-46.125 -13.4L-46.125 -10.4L-44.125 -8.4L-44.125 -5.4L-42.125 -3.4L-42.125 -0.4L-40.125 1.6L-40.125 4.6L-38.125 6.6L-38.125 9.6L-36.125 11.6L-36.125 14.6L-34.125 16.6L-34.125 19.6L-32.125 21.6L-32.125 24.6L-30.125 26.6L-30.125 29.6L-28.125 31.6L-28.125 34.6L-26.125 36.6L-26.125 39.6L-24.125 41.6L-24.125 44.6L-22.125 46.6L-22.125 49.6L-20.125 51.6L-20.125 54.6L-18.125 56.6L-18.125 59.6L-16.125 61.6L-16.125 64.6L-14.125 66.6L-14.125 69.6L-12.125 71.6L-12.125 74.6L-10.125 76.6L-10.125 79.6L-8.125 81.6L-8.125 84.6L-6.125 86.6L-6.125 89.6L-4.125 91.6L-4.125 94.6L-2.125 96.6L-2.125 99.6L-0.125 101.6L-0.125 104.6L1.875 106.6L1.875 109.6L3.875 111.6L3.875 114.6L5.875 116.6L5.875 119.6L7.875 121.6L7.875 124.6L9.875 126.6L9.875 129.6L11.875 131.6L11.875 134.6L13.875 136.6L13.875 139.6L15.875 141.6L15.875 144.6L17.875 146.6L17.875 149.6L19.875 151.6L19.875 154.6L21.875 156.6L21.875 159.6L23.875 161.6L23.875 164.6L25.875 166.6L25.875 169.6L27.875 171.6L27.875 174.6L29.875 176.6L29.875 179.6L31.875 181.6L31.875 184.6L33.875 186.6L33.875 189.6L35.875 191.6L35.875 194.6L37.875 196.6L37.875 199.6L39.875 201.6L39.875 204.6L41.875 206.6L41.875 209.6L43.875 211.6L43.875 214.6L45.875 216.6L45.875 219.6L47.875 221.6L47.875 224.6L49.875 226.6L49.875 229.6L51.875 231.6L51.875 234.6L53.875 236.6L53.875 239.6L55.875 241.6L55.875 244.6L57.875 246.6L57.875 249.6L59.875 251.6L59.875 254.6L61.875 256.6L61.875 259.6L63.875 261.6L63.875 264.6L65.875 266.6L65.875 269.6L67.875 271.6L67.875 274.6L69.875 276.6L69.875 279.6L71.875 281.6L71.875 284.6L73.875 286.6L73.875 289.6L75.875 291.6L75.875 294.6L77.875 296.6L77.875 299.6L79.875 301.6L79.875 304.6L81.875 306.6L81.875 309.6L83.875 311.6L83.875 314.6L85.875 316.6L85.875 319.6L87.875 321.6L87.875 324.6L89.875 326.6L89.875 329.6L91.875 331.6L91.875 334.6L93.875 336.6L93.875 339.6L95.875 341.6L95.875 344.6L97.875 346.6L97.875 349.6L99.875 351.6L99.875 354.6L101.875 356.6L101.875 359.6L103.875 361.6L103.875 364.6L105.875 366.6L105.875 369.6L107.875 371.6L107.875 374.6L109.875 376.6L109.875 379.6L111.875 381.6L111.875 384.6L113.875 386.6L113.875 389.6L115.875 391.6L115.875 394.6L117.875 396.6L117.875 399.6L119.875 401.6L119.875 404.6L121.875 406.6L121.875 409.6L123.875 411.6L123.875 414.6L125.875 416.6L125.875 419.6L127.875 421.6L127.875 424.6L129.875 426.6L129.875 429.6L131.875 431.6L131.875 434.6L133.875 436.6L133.875 439.6L135.875 441.6L135.875 444.6L137.875 446.6L137.875 449.6L139.875 451.6L139.875 454.6L141.875 456.6L141.875 459.6L143.875 461.6L143.875 464.6L145.875 466.6L145.875 469.6L147.875 471.6L147.875 474.6L149.875 476.6L149.875 479.6L151.875 481.6L151.875 484.6L153.875 486.6L153.875 489.6L155.875 491.6L155.875 494.6L157.875 496.6L157.875 499.6L159.875 501.6L159.875 504.6L161.875 506.6L161.875 509.6L163.875 511.6L163.875 514.6L165.875 516.6L165.875 519.6L167.875 521.6L167.875 524.6L169.875 526.6L169.875 529.6L171.875 531.6L171.875 534.6L173.875 536.6L173.875 539.6L175.875 541.6L175.875 544.6L177.875 546.6L177.875 549.6L179.875 551.6L179.875 554.6L181.875 556.6L181.875 559.6L183.875 561.6L183.875 564.6L185.875 566.6L185.875 569.6L187.875 571.6L187.875 574.6L189.875 576.6L189.875 579.6L191.875 581.6L191.875 584.6L193.875 586.6L193.875 589.6L195.875 591.6L195.875 594.6L197.875 596.6L197.875 599.6L199.875 601.6L199.875 604.6L201.875 606.6L201.875 609.6L203.875 611.6L203.875 614.6L205.875 616.6L205.875 619.6L207.875 621.6L207.875 624.6L209.875 626.6L209.875 629.6L211.875 631.6L211.875 634.6L213.875 636.6L213.875 639.6L215.875 641.6L215.875 644.6L217.875 646.6L217.875 649.6L219.875 651.6L219.875 654.6L221.875 656.6L221.875 659.6L223.875 661.6L223.875 664.6L225.875 666.6L225.875 669.6L227.875 671.6L227.875 674.6L229.875 676.6L229.875 679.6L231.875 681.6L231.875 684.6L233.875 686.6L233.875 689.6L235.875 691.6L235.875 694.6L237.875 696.6L237.875 699.6L239.875 701.6L239.875 704.6L241.875 706.6L241.875 709.6L243.875 711.6L243.875 714.6L245.875 716.6L245.875 719.6L247.875 721.6L247.875 724.6L249.875 726.6L249.875 729.6L251.875 731.6L251.875 734.6L253.875 736.6L253.875 739.6L255.875 741.6L255.875 744.6L257.875 746.6L257.875 749.6L259.875 751.6L259.875 754.6L261.875 756.6L261.875 759.6L263.875 761.6L263.875 764.6L265.875 766.6L265.875 769.6L267.875 771.6L267.875 774.6L269.875 776.6L269.875 779.6L271.875 781.6L271.875 784.6L273.875 786.6L273.875 789.6L275.875 791.6L275.875 794.6L277.875 796.6L277.875 799.6L279.875 801.6L279.875 804.6L281.875 806.6L281.875 809.6L283.875 811.6L283.875 814.6L285.875 816.6L285.875 819.6L287.875 821.6L287.875 824.6L289.875 826.6L289.875 829.6L291.875 831.6L291.875 834.6L293.875 836.6L293.875 839.6L295.875 841.6L295.875 844.6L297.875 846.6L297.875 849.6L299.875 851.6L299.875 854.6L301.875 856.6L301.875 859.6L303.875 861.6L303.875 864.6L305.875 866.6L305.875 869.6L307.875 871.6L307.875 874.6L309.875 876.6L309.875 879.6L311.875 881.6L311.875 884.6L313.875 886.6L313.875 889.6L315.875 891.6L315.875 894.6L317.875 896.6L317.875 899.6L319.875 901.6L319.875 904.6L321.875 906.6L321.875 909.6L323.875 911.6L323.875 914.6L325.875 916.6L325.875 919.6L327.875 921.6L327.875 924.6L329.875 926.6L329.875 929.6L331.875 931.6L331.875 934.6L333.875 936.6L333.875 939.6L335.875 941.6L335.875 944.6L337.875 946.6L337.875 949.6L339.875 951.6L339.875 954.6L341.875 956.6L341.875 959.6L343.875 961.6L343.875 964.6L345.875 966.6L345.875 969.6L347.875 971.6L347.875 974.6L349.875 976.6L349.875 979.6L351.875 981.6L351.875 984.6L353.875 986.6L353.875 989.6L355.875 991.6L355.875 994.6L357.875 996.6L357.875 999.6L359.875 1001.6L359.875 1004.6L361.875 1006.6L361.875 1009.6L363.875 1011.6L363.875 1014.6L365.875 1016.6L365.875 1019.6L367.875 1021.6L367.875 1024.6L369.875 1026.6L369.875 1029.6L371.875 1031.6L371.875 1034.6L373.875 1036.6L373.875 1039.6L375.875 1041.6L375.875 1044.6L377.875 1046.6L377.875 1049.6L379.875 1051.6L379.875 1054.6L381.875 1056.6L381.875 1059.6L383.875 1061.6L383.875 1064.6L385.875 1066.6L385.875 1069.6L387.875 1071.6L387.875 1074.6L389.875 1076.6L389.875 1079.6L391.875 1081.6L391.875 1084.6L393.875 1086.6L393.875 1089.6L395.875 1091.6L395.875 1094.6L397.875 1096.6L397.875 1099.6L399.875 1101.6L399.875 1104.6L401.875 1106.6L401.875 1109.6L403.875 1111.6L403.875 1114.6L405.875 1116.6L405.875 1119.6L407.875 1121.6L407.875 1124.6L409.875 1126.6L409.875 1129.6L411.875 1131.6L411.875 1134.6L413.875 1136.6L413.875 1139.6L415.875 1141.6L415.875 1144.6L417.875 1146.6L417.875 1149.6L419.875 1151.6L419.875 1154.6L421.875 1156.6L421.875 1159.6L423.875 1161.6L423.875 1164.6L425.875 1166.6L425.875 1169.6L427.875 1171.6L427.875 1174.6L429.875 1176.6L429.875 1179.6L431.875 1181.6L431.875 1184.6L433.875 1186.6L433.875 1189.6L435.875 1191.6L435.875 1194.6L437.875 1196.6L437.875 1199.6L439.875 1201.6L439.875 1204.6L441.875 1206.6L441.875 1209.6L443.875 1211.6L443.875 1214.6L445.875 1216.6L445.875 1219.6L447.875 1221.6L447.875 1224.6L449.875 1226.6L449.875 1229.6L451.875 1231.6L451.875 1234.6L453.875 1236.6L453.875 1239.6L455.875 1241.6L455.875 1244.6L457.875 1246.6L457.875 1249.6L459.875 1251.6L459.875 1254.6L461.875 1256.6L461.875 1259.6L463.875 1261.6L463.875 1264.6L465.875 1266.6L465.875 1269.6L467.875 1271.6L467.875 1274.6L469.875 1276.6L469.875 1279.6L471.875 1281.6L471.875 1284.6L473.875 1286.6L473.875 1289.6L475.875 1291.6L475.875 1294.6L477.875 1296.6L477.875 1299.6L479.875 1301.6L479.875 1304.6L481.875 1306.6L481.875 1309.6L483.875 1311.6L483.875 1314.6L485.875 1316.6L485.875 1319.6L487.875 1321.6L487.875 1324.6L489.875 1326.6L489.875 1329.6L491.875 1331.6L491.875 1334.6L493.875 1336.6L493.875 1339.6L495.875 1341.6L495.875 1344.6L497.875 1346.6L497.875 1349.6L499.875 1351.6L499.875 1354.6L501.875 1356.6L501.875 1359.6L503.875 1361.6L503.875 1364.6L505.875 1366.6L505.875 1369.6L507.875 1371.6L507.875 1374.6L509.875 1376.6L509.875 1379.6L511.875 1381.6L511.875 1384.6L513.875 1386.6L513.875 1389.6L515.875 1391.6L515.875 1394.6L517.875 1396.6L517.875 1399.6L519.875 1401.6L519.875 1404.6L521.875 1406.6L521.875 1409.6L523.875 1411.6L523.875 1414.6L525.875 1416.6L525.875 1419.6L527.875 1421.6L527.875 1424.6L529.875 1426.6L529.875 1429.6L531.875 1431.6L531.875 1434.6L533.875 1436.6L533.875 1439.6L535.875 1441.6L535.875 1444.6L537.875 1446.6L537.875 1449.6L539.875 1451.6L539.875 1454.6L541.875 1456.6L541.875 1459.6L543.875 1461.6L543.875 1464.6L545.875 1466.6L545.875 1469.6L547.875 1471.6L547.875 1474.6L549.875 1476.6L549.875 1479.6L551.875 1481.6L551.875 1484.6L553.875 1486.6L553.875 1489.6L555.875 1491.6L555.875 1494.6L557.875 1496.6L557.875 1499.6L559.875 1501.6L559.875 1504.6L561.875 1506.6L561.875 1509.6L563.875 1511.6L563.875 1514.6L565.875 1516.6L565.875 1519.6L567.875 1521.6L567.875 1524.6L569.875 1526.6L569.875 1529.6L571.875 1531.6L571.875 1534.6L573.875 1536.6L573.875 1539.6L575.875 1541.6L575.875 1544.6L577.875 1546.6L577.875 1549.6L579.875 1551.6L579.875 1554.6L581.875 1556.6L581.875 1559.6L583.875 1561.6L583.875 1564.6L585.875 1566.6L585.875 1569.6L587.875 1571.6L587.875 1574.6L589.875 1576.6L589.875 1579.6L591.875 1581.6L591.875 1584.6L593.875 1586.6L593.875 1589.6L595.875 1591.6L595.875 1594.6L597.875 1596.6L597.875 1599.6L599.875 1601.6L599.875 1604.6L601.875 1606.6L601.875 1609.6L603.875 1611.6L603.875 1614.6L605.875 1616.6L605.875 1619.6L607.875 1621.6L607.875 1624.6L609.875 1626.6L609.875 1629.6L611.875 1631.6L611.875 1634.6L613.875 1636.6L613.875 1639.6L615.875 1641.6L615.875 1644.6L617.875 1646.6L617.875 1649.6L619.875 1651.6L619.875 1654.6L621.875 1656.6L621.875 1659.6L623.875 1661.6L623.875 1664.6L625.875 1666.6L625.875 1669.6L627.875 1671.6L627.875 1674.6L629.875 1676.6L629.875 1679.6L631.875 1681.6L631.875 1684.6L633.875 1686.6L633.875 1689.6L635.875 1691.6L635.875 1694.6L637.875 1696.6L637.875 1699.6L639.875 1701.6L639.875 1704.6L641.875 1706.6L641.875 1709.6L643.875 1711.6L643.875 1714.6L645.875 1716.6L645.875 1719.6L647.875 1721.6L647.875 1724.6L649.875 1726.6L649.875 1729.6L651.875 1731.6L651.875 1734.6L653.875 1736.6L653.875 1739.6L655.875 1741.6L655.875 1744.6L657.875 1746.6L657.875 1749.6L659.875 1751.6L659.875 1754.6L661.875 1756.6L661.875 1759.6L663.875 1761.6L663.875 1764.6L665.875 1766.6L665.875 1769.6L667.875 1771.6L667.875 1774.6L669.875 1776.6L669.875 1779.6L671.875 1781.6L671.875 1784.6L673.875 1786.6L673.875 1789.6L675.875 1791.6L675.875 1794.6L677.875 1796.6L677.875 1799.6L679.875 1801.6L679.875 1804.6L681.875 1806.6L681.875 1809.6L683.875 1811.6L683.875 1814.6L685.875 1816.6L685.875 1819.6L687.875 1821.6L687.875 1824.6L689.875 1826.6L689.875 1829.6L691.875 1831.6L691.875 1834.6L693.875 1836.6L693.875 1839.6L695.875 1841.6L695.875 1844.6L697.875 1846.6L697.875 1849.6L699.875 1851.6L699.875 1854.6L701.875 1856.6L701.875 1859.6L703.875 1861.6L703.875 1864.6L705.875 1866.6L705.875 1869.6L707.875 1871.6L707.875 1874.6L709.875 1876.6L709.875 1879.6L711.875 1881.6L711.875 1884.6L713.875 1886.6L713.875 1889.6L715.875 1891.6L715.875 1894.6L717.875 1896.6L717.875 1899.6L719.875 1901.6L719.875 1904.6L721.875 1906.6L721.875 1909.6L723.875 1911.6L723.875 1914.6L725.875 1916.6L725.875 1919.6L727.875 1921.6L727.875 1924.6L729.875 1926.6L729.875 1929.6L731.875 1931.6L731.875 1934.6L733.875 1936.6L733.875 1939.6L735.875 1941.6L735.875 1944.6L737.875 1946.6L737.875 1949.6L739.875 1951.6L739.875 1954.6L741.875 1956.6L741.875 1959.6L743.875 1961.6L743.875 1964.6L745.875 1966.6L745.875 1969.6L747.875 1971.6L747.875 1974.6L749.875 1976.6L749.875 1979.6L751.875 1981.6L751.875 1984.6L753.875 1986.6L753.875 1989.6L755.875 1991.6L755.875 1994.6L757.875 1996.6L757.875 1999.6L759.875 2001.6L759.875 2004.6L761.875 2006.6L761.875 2009.6L763.875 2011.6L763.875 2014.6L765.875 2016.6L765.875 2019.6L767.875 2021.6L767.875 2024.6L769.875 2026.6L769.875 2029.6L771.875 2031.6L771.875 2034.6L773.875 2036.6L773.875 2039.6L775.875 2041.6L775.875 2044.6L777.875 2046.6L777.875 2049.6L779.875 2051.6L779.875 2054.6L781.875 2056.6L781.875 2059.6L783.875 2061.6L783.875 2064.6L785.875 2066.6L785.875 2069.6L787.875 2071.6L787.875 2074.6L789.875 2076.6L789.875 2079.6L791.875 2081.6L791.875 2084.6L793.875 2086.6L793.875 2089.6L795.875 2091.6L795.875 2094.6L797.875 2096.6L797.875 2099.6L799.875 2101.6L799.875 2104.6L801.875 2106.6L801.875 2109.6L803.875 2111.6L803.875 2114.6L805.875 2116.6L805.875 2119.6L807.875 2121.6L807.875 2124.6L809.875 2126.6L809.875 2129.6L811.875 2131.6L811.875 2134.6L813.875 2136.6L813.875 2139.6L815.875 2141.6L815.875 2144.6L817.875 2146.6L817.875 2149.6L819.875 2151.6L819.875 2154.6L821.875 2156.6L821.875 2159.6L823.875 2161.6L823.875 2164.6L825.875 2166.6L825.875 2169.6L827.875 2171.6L827.875 2174.6L829.875 2176.6L829.875 2179.6L831.875 2181.6L831.875 2184.6L833.875 2186.6L833.875 2189.6L835.875 2191.6L835.875 2194.6L837.875 2196.6L837.875 2199.6L839.875 2201.6L839.875 2204.6L841.875 2206.6L841.875 2209.6L843.875 2211.6L843.875 2214.6L845.875 2216.6L845.875 2219.6L847.875 2221.6L847.875 2224.6L849.875 2226.6L849.875 2229.6L851.875 2231.6L851.875 2234.6L853.875 2236.6L853.875 2239.6L855.875 2241.6L855.875 2244.6L857.875 2246.6L857.875 2249.6L859.875 2251.6L859.875 2254.6L861.875 2256.6L861.875 2259.6L863.875 2261.6L863.875 2264.6L865.875 2266.6L865.875 2269.6L867.875 2271.6L867.875 2274.6L869.875 2276.6L869.875 2279.6L871.875 2281.6L871.875 2284.6L873.875 2286.6L873.875 2289.6L875.875 2291.6L875.875 2294.6L877.875 2296.6L877.875 2299.6L879.875 2301.6L879.875 2304.6L881.875 2306.6L881.875 2309.6L883.875 2311.6L883.875 2314.6L885.875 2316.6L885.875 2319.6L887.875 2321.6L887.875 2324.6L889.875 2326.6L889.875 2329.6L891.875 2331.6L891.875 2334.6L893.875 2336.6L893.875 2339.6L895.875 2341.6L895.875 2344.6L897.875 2346.6L897.875 2349.6L899.875 2351.6L899.875 2354.6L901.875 2356.6L901.875 2359.6L903.875 2361.6L903.875 2364.6L905.875 2366.6L905.875 2369.6L907.875 2371.6L907.875 2374.6L909.875 2376.6L909.875 2379.6L911.875 2381.6L911.875 2384.6L913.875 2386.6L913.875 2389.6L915.875 2391.6L915.875 2394.6L917.875 2396.6L917.875 2399.6L919.875 2401.6L919.875 2404.6L921.875 2406.6L921.875 2409.6L923.875 2411.6L923.875 2414.6L925.875 2416.6L925.875 2419.6L927.875 2421.6L927.875 2424.6L929.875 2426.6L929.875 2429.6L931.875 2431.6L931.875 2434.6L933.875 2436.6L933.875 2439.6L935.875 2441.6L935.875 2444.6L937.875 2446.6L937.875 2449.6L939.875 2451.6L939.875 2454.6L941.875 2456.6L941.875 2459.6L943.875 2461.6L943.875 2464.6L945.875 2466.6L945.875 2469.6L947.875 2471.6L947.875 2474.6L949.875 2476.6L949.875 2479.6L951.875 2481.6L951.875 2484.6L953.875 2486.6L953.875 2489.6L955.875 2491.6L955.875 2494.6L957.875 2496.6L957.875 2499.6L959.875 2501.6L959.875 2504.6L961.875 2506.6L961.875 2509.6L963.875 2511.6L963.875 2514.6L965.875 2516.6L965.875 2519.6L967.875 2521.6L967.875 2524.6L969.875 2526.6L969.875 2529.6L971.875 2531.6L971.875 2534.6L973.875 2536.6L973.875 2539.6L975.875 2541.6L975.875 2544.6L977.875 2546.6L977.875 2549.6L979.875 2551.6L979.875 2554.6L981.875 2556.6L981.875 2559.6L983.875 2561.6L983.875 2564.6L985.875 2566.6L985.875 2569.6L987.875 2571.6L987.875 2574.6L989.875 2576.6L989.875 2579.6L991.875 2581.6L991.875 2584.6L993.875 2586.6L993.875 2589.6L995.875 2591.6L995.875 2594.6L997.875 2596.6L997.875 2599.6L999.875 2601.6L999.875 2604.6L1001.875 2606.6L1001.875 2609.6L1003.875 2611.6L1003.875 2614.6L1005.875 2616.6L1005.875 2619.6L1007.875 2621.6L1007.875 2624.6L1009.875 2626.6L1009.875 2629.6L1011.875 2631.6L1011.875 2634.6L1013.875 2636.6L1013.875 2639.6L1015.875 2641.6L1015.875 2644.6L1017.875 2646.6L1017.875 2649.6L1019.875 2651.6L1019.875 2654.6L1021.875 2656.6L1021.875 2659.6L1023.875 2661.6L1023.875 2664.6L1025.875 2666.6L1025.875 2669.6L1027.875 2671.6L1027.875 2674.6L1029.875 2676.6L1029.875 2679.6L1031.875 2681.6L1031.875 2684.6L1033.875 2686.6L1033.875 2689.6L1035.875 2691.6L1035.875 2694.6L1037.875 2696.6L1037.875 2699.6L1039.875 2701.6L1039.875 2704.6L1041.875 2706.6L1041.875 2709.6L1043.875 2711.6L1043.875 2714.6L1045.875 2716.6L1045.875 2719.6L1047.875 2721.6L1047.875 2724.6L1049.875 2726.6L1049.875 2729.6L1051.875 2731.6L1051.875 2734.6L1053.875 2736.6L1053.875 2739.6L1055.875 2741.6L1055.875 2744.6L1057.875 2746.6L1057.875 2749.6L1059.875 2751.6L1059.875 2754.6L1061.875 2756.6L1061.875 2759.6L1063.875 2761.6L1063.875 2764.6L1065.875 2766.6L1065.875 2769.6L1067.875 2771.6L1067.875 2774.6L1069.875 2776.6L1069.875 2779.6L1071.875 2781.6L1071.875 2784.6L1073.875 2786.6L1073.875 2789.6L1075.875 2791.6L1075.875 2794.6L1077.875 2796.6L1077.875 2799.6L1079.875 2801.6L1079.875 2804.6L1081.875 2806.6L1081.875 2809.6L1083.875 2811.6L1083.875 2814.6L1085.875 2816.6L1085.875 2819.6L1087.875 2821.6L1087.875 2824.6L1089.875 2826.6L1089.875 2829.6L1091.875 2831.6L1091.875 2834.6L1093.875 2836.6L1093.875 2839.6L1095.875 2841.6L1095.875 2844.6L1097.875 2846.6L1097.875 2849.6L1099.875 2851.6L1099.875 2854.6L1101.875 2856.6L1101.875 2859.6L1103.875 2861.6L1103.875 2864.6L1105.875 2866.6L1105.875 2869.6L1107.875 2871.6L1107.875 2874.6L1109.875 2876.6L1109.875 2879.6L1111.875 2881.6L1111.875 2884.6L1113.875 2886.6L1113.875 2889.6L1115.875 2891.6L1115.875 2894.6L1117.875 2896.6L1117.875 2899.6L1119.875 2901.6L1119.875 2904.6L1121.875 2906.6L1121.875 2909.6L1123.875 2911.6L1123.875 2914.6L1125.875 2916.6L1125.875 2919.6L1127.875 2921.6L1127.875 2924.6L1129.875 2926.6L1129.875 2929.6L1131.875 2931.6L1131.875 2934.6L1133.875 2936.6L1133.875 2939.6L1135.875 2941.6L1135.875 2944.6L1137.875 2946.6L1137.875 2949.6L1139.875 2951.6L1139.875 2954.6L1141.875 2956.6L1141.875 2959.6L1143.875 2961.6L1143.875 2964.6L1145.875 2966.6L1145.875 2969.6L1147.875 2971.6L1147.875 2974.6L1149.875 2976.6L1149.875 2979.6L1151.875 2981.6L1151.875 2984.6L1153.875 2986.6L1153.875 2989.6L1155.875 2991.6L1155.875 2994.6L1157.875 2996.6L1157.875 2999.6L1159.875 3001.6L1159.875 3004.6L1161.875 3006.6L1161.875 3009.6L1163.875 3011.6L1163.875 3014.6L1165.875 3016.6L1165.875 3019.6L1167.875 3021.6L1167.875 3024.6L1169.875 3026.6L1169.875 3029.6L1171.875 3031.6L1171.875 3034.6L1173.875 3036.6L1173.875 3039.6L1175.875 3041.6L1175.875 3044.6L1177.875 3046.6L1177.875 3049.6L1179.875 3051.6L1179.875 3054.6L1181.875 3056.6L1181.875 3059.6L1183.875 3061.6L1183.875 3064.6L1185.875 3066.6L1185.875 3069.6L1187.875 3071.6L1187.875 3074.6L1189.875 3076.6L1189.875 3079.6L1191.875 3081.6L1191.875 3084.6L1193.875 3086.6L1193.875 3089.6L1195.875 3091.6L1195.875 3094.6L1197.875 3096.6L1197.875 3099.6L1199.875 3101.6L1199.875 3104.6L1201.875 3106.6L1201.875 3109.6L1203.875 3111.6L1203.875 3114.6L1205.875 3116.6L1205.875 3119.6L1207.875 3121.6L1207.875 3124.6L1209.875 3126.6L1209.875 3129.6L1211.875 3131.6L1211.875 3134.6L1213.875 3136.6L1213.875 3139.6L1215.875 3141.6L1215.875 3144.6L1217.875 3146.6L1217.875 3149.6L1219.875 3151.6L1219.875 3154.6L1221.875 3156.6L1221.875 3159.6L1223.875 3161.6L1223.875 3164.6L1225.875 3166.6L1225.875 3169.6L1227.875 3171.6L1227.875 3174.6L1229.875 3176.6L1229.875 3179.6L1231.875 3181.6L1231.875 3184.6L1233.875 3186.6L1233.875 3189.6L1235.875 3191.6L1235.875 3194.6L1237.875 3196.6L1237.875 3199.6L1239.875 3201.6L1239.875 3204.6L1241.875 3206.6L1241.875 3209.6L1243.875 3211.6L1243.875 3214.6L1245.875 3216.6L1245.875 3219.6L1247.875 3221.6L1247.875 3224.6L1249.875 3226.6L1249.875 3229.6L1251.875 3231.6L1251.875 3234.6L1253.875 3236.6L1253.875 3239.6L1255.875 3241.6L1255.875 3244.6L1257.875 3246.6L1257.875 3249.6L1259.875 3251.6L1259.875 3254.6L1261.875 3256.6L1261.875 3259.6L1263.875 3261.6L1263.875 3264.6L1265.875 3266.6L1265.875 3269.6L1267.875 3271.6L1267.875 3274.6L1269.875 3276.6L1269.875 3279.6L1271.875 3281.6L1271.875 3284.6L1273.875 3286.6L1273.875 3289.6L1275.875 3291.6L1275.875 3294.6L1277.875 3296.6L1277.875 3299.6L1279.875 3301.6L1279.875 3304.6L1281.875 3306.6L1281.875 3309.6L1283.875 3311.6L1283.875 3314.6L1285.875 3316.6L1285.875 3319.6L1287.875 3321.6L1287.875 3324.6L1289.875 3326.6L1289.875 3329.6L1291.875 3331.6L1291.875 3334.6L1293.875 3336.6L1293.875 3339.6L1295.875 3341.6L1295.875 3344.6L1297.875 3346.6L1297.875 3349.6L1299.875 3351.6L1299.875 3354.6L1301.875 3356.6L1301.875 3359.6L1303.875 3361.6L1303.875 3364.6L1305.875 3366.6L1305.875 3369.6L1307.875 3371.6L1307.875 3374.6L1309.875 3376.6L1309.875 3379.6L1311.875 3381.6L1311.875 3384.6L1313.875 3386.6L1313.875 3389.6L1315.875 3391.6L1315.875 3394.6L1317.875 3396.6L1317.875 3399.6L1319.875 3401.6L1319.875 3404.6L1321.875 3406.6L1321.875 3409.6L1323.875 3411.6L1323.875 3414.6L1325.875 3416.6L1325.875 3419.6L1327.875 3421.6L1327.875 3424.6L1329.875 3426.6L1329.875 3429.6L1331.875 3431.6L1331.875 3434.6L1333.875 3436.6L1333.875 3439.6L1335.875 3441.6L1335.875 3444.6L1337.875 3446.6L1337.875 3449.6L1339.875 3451.6L1339.875 3454.6L1341.875 3456.6L1341.875 3459.6L1343.875 3461.6L1343.875 3464.6L1345.875 3466.6L1345.875 3469.6L1347.875 3471.6L1347.875 3474.6L1349.875 3476.6L1349.875 3479.6L1351.875 3481.6L1351.875 3484.6L1353.875 3486.6L1353.875 3489.6L1355.875 3491.6L1355.875 3494.6L1357.875 3496.6L1357.875 3499.6L1359.875 3501.6L1359.875 3504.6L1361.875 3506.6L1361.875 3509.6L1363.875 3511.6L1363.875 3514.6L1365.875 3516.6L1365.875 3519.6L1367.875 3521.6L1367.875 3524.6L1369.875 3526.6L1369.875 3529.6L1371.875 3531.6L1371.875 3534.6L1373.875 3536.6L1373.875 3539.6L1375.875 3541.6L1375.875 3544.6L1377.875 3546.6L1377.875 3549.6L1379.875 3551.6L1379.875 3554.6L1381.875 3556.6L1381.875 3559.6L1383.875 3561.6L1383.875 3564.6L1385.875 3566.6L1385.875 3569.6L1387.875 3571.6L1387.875 3574.6L1389.875 3576.6L1389.875 3579.6L1391.875 3581.6L1391.875 3584.6L1393.875 3586.6L1393.875 3589.6L1395.875 3591.6L1395.875 3594.6L1397.875 3596.6L1397.875 3599.6L1399.875 3601.6L1399.875 3604.6L1401.875 3606.6L1401.875 3609.6L1403.875 3611.6L1403.875 3614.6L1405.875 3616.6L1405.875 3619.6L1407.875 3621.6L1407.875 3624.6L1409.875 3626.6L1409.875 3629.6L1411.875 3631.6L1411.875 3634.6L1413.875 3636.6L1413.875 3639.6L1415.875 3641.6L1415.875 3644.6L1417.875 3646.6L1417.875 3649.6L1419.875 3651.6L1419.875 3654.6L1421.875 3656.6L1421.875 3659.6L1423.875 3661.6L1423.875 3664.6L1425.875 3666.6L1425.875 3669.6L1427.875 3671.6L1427.875 3674.6L1429.875 3676.6L1429.875 3679.6L1431.875 3681.6L1431.875 3684.6L1433.875 3686.6L1433.875 3689.6L1435.875 3691.6L1435.875 3694.6L1437.875 3696.6L1437.875 3699.6L1439.875 3701.6L1439.875 3704.6L1441.875 3706.6L1441.875 3709.6L1443.875 3711.6L1443.875 3714.6L1445.875 3716.6L1445.875 3719.6L1447.875 3721.6L1447.875 3724.6L1449.875 3726.6L1449.875 3729.6L1451.875 3731.6L1451.875 3734.6L1453.875 3736.6L1453.875 3739.6L1455.875 3741.6L1455.875 3744.6L1457.875 3746.6L1457.875 3749.6L1459.875 3751.6L1459.875 3754.6L1461.875 3756.6L1461.875 3759.6L1463.875 3761.6L1463.875 3764.6L1465.875 3766.6L1465.875 3769.6L1467.875 3771.6L1467.875 3774.6L1469.875 3776.6L1469.875 3779.6L1471.875 3781.6L1471.875 3784.6L1473.875 3786.6L1473.875 3789.6L1475.875 3791.6L1475.875 3794.6L1477.875 3796.6L1477.875 3799.6L1479.875 3801.6L1479.875 3804.6L1481.875 3806.6L1481.875 3809.6L1483.875 3811.6L1483.875 3814.6L1485.875 3816.6L1485.875 3819.6L1487.875 3821.6L1487.875 3824.6L1489.875 3826.6L1489.875 3829.6L1491.875 3831.6L1491.875 3834.6L1493.875 3836.6L1493.875 3839.6L1495.875 3841.6L1495.875 3844.6L1497.875 3846.6L1497.875 3849.6L1499.875 3851.6L1499.875 3854.6L1501.875 3856.6L1501.875 3859.6L1503.875 3861.6L1503.875 3864.6L1505.875 3866.6L1505.875 3869.6L1507.875 3871.6L1507.875 3874.6L1509.875 3876.6L1509.875 3879.6L1511.875 3881.6L1511.875 3884.6L1513.875 3886.6L1513.875 3889.6L1515.875 3891.6L1515.875 3894.6L1517.875 3896.6L1517.875 3899.6L1519.875 3901.6L1519.875 3904.6L1521.875 3906.6L1521.875 3909.6L1523.875 3911.6L1523.875 3914.6L1525.875 3916.6L1525.875 3919.6L1527.875 3921.6L1527.875 3924.6L1529.875 3926.6L1529.875 3929.6L1531.875 3931.6L1531.875 3934.6L1533.875 3936.6L1533.875 3939.6L1535.875 3941.6L1535.875 3944.6L1537.875 3946.6L1537.875 3949.6L1539.875 3951.6L1539.875 3954.6L1541.875 3956.6L1541.875 3959.6L1543.875 3961.6L1543.875 3964.6L1545.875 3966.6L1545.875 3969.6L1547.875 3971.6L1547.875 3974.6L1549.875 3976.6L1549.875 3979.6L1551.875 3981.6L1551.875 3984.6L1553.875 3986.6L1553.875 3989.6L1555.875 3991.6L1555.875 3994.6L1557.875 3996.6L1557.875 3999.6L1559.875 4001.6L1559.875 4004.6L1561.875 4006.6L1561.875 4009.6L1563.875 4011.6L1563.875 4014.6L1565.875 4016.6L1565.875 4019.6L1567.875 4021.6L1567.875 4024.6L1569.875 4026.6L1569.875 4029.6L1571.875 4031.6L1571.875 4034.6L1573.875 4036.6L1573.875 4039.6L1575.875 4041.6L1575.875 4044.6L1577.875 4046.6L1577.875 4049.6L1579.875 4051.6L1579.875 4054.6L1581.875 4056.6L1581.875 4059.6L1583.875 4061.6L1583.875 4064.6L1585.875 4066.6L1585.875 4069.6L1587.875 4071.6L1587.875 4074.6L1589.875 4076.6L1589.875 4079.6L1591.875 4081.6L1591.875 4084.6L1593.875 4086.6L1593.875 4089.6L1595.875 4091.6L1595.875 4094.6L1597.875 4096.6L1597.875 4099.6L1599.875 4101.6L1599.875 4104.6L1601.875 4106.6L1601.875 4109.6L1603.875 4111.6L1603.875 4114.6L1605.875 4116.6L1605.875 4119.6L1607.875 4121.6L1607.875 4124.6L1609.875 4126.6L1609.875 4129.6L1611.875 4131.6L1611.875 4134.6L1613.875 4136.6L1613.875 4139.6L1615.875 4141.6L1615.875 4144.6L1617.875 4146.6L1617.875 4149.6L1619.875 4151.6L1619.875 4154.6L1621.875 4156.6L1621.875 4159.6L1623.875 4161.6L1623.875 4164.6L1625.875 4166.6L1625.875 4169.6L1627.875 4171.6L1627.875 4174.6L1629.875 4176.6L1629.875 4179.6L1631.875 4181.6L1631.875 4184.6L1633.875 4186.6L1633.875 4189.6L1635.875 4191.6L1635.875 4194.6L1637.875 4196.6L1637.875 4199.6L1639.875 4201.6L1639.875 4204.6L1641.875 4206.6L1641.875 4209.6L1643.875 4211.6L1643.875 4214.6L1645.875 4216.6L1645.875 4219.6L1647.875 4221.6L1647.875 4224.6L1649.875 4226.6L1649.875 4229.6L1651.875 4231.6L1651.875 4234.6L1653.875 4236.6L1653.875 4239.6L1655.875 4241.6L1655.875 4244.6L1657.875 4246.6L1657.875 4249.6L1659.875 4251.6L1659.875 4254.6L1661.875 4256.6L1661.875 4259.6L1663.875 4261.6L1663.875 4264.6L1665.875 4266.6L1665.875 4269.6L1667.875 4271.6L1667.875 4274.6L1669.875 4276.6L1669.875 4279.6L1671.875 4281.6L1671.875 4284.6L1673.875 4286.6L1673.875 4289.6L1675.875 4291.6L1675.875 4294.6L1677.875 4296.6L1677.875 4299.6L1679.875 4301.6L1679.875 4304.6L1681.875 4306.6L1681.875 4309.6L1683.875 4311.6L1683.875 4314.6L1685.875 4316.6L1685.875 4319.6L1687.875 4321.6L1687.875 4324.6L1689.875 4326.6L1689.875 4329.6L1691.875 4331.6L1691.875 4334.6L1693.875 4336.6L1693.875 4339.6L1695.875 4341.6L1695.875 4344.6L1697.875 4346.6L1697.875 4349.6L1699.875 4351.6L1699.875 4354.6L1701.875 4356.6L1701.875 4359.6L1703.875 4361.6L1703.875 4364.6L1705.875 4366.6L1705.875 4369.6L1707.875 4371.6L1707.875 4374.6L1709.875 4376.6L1709.875 4379.6L1711.875 4381.6L1711.875 4384.6L1713.875 4386.6L1713.875 4389.6L1715.875 4391.6L1715.875 4394.6L1717.875 4396.6L1717.875 4399.6L1719.875 4401.6L1719.875 4404.6L1721.875 4406.6L1721.875 4409.6L1723.875 4411.6L1723.875 4414.6L1725.875 4416.6L1725.875 4419.6L1727.875 4421.6L1727.875 4424.6L1729.875 4426.6L1729.875 4429.6L1731.875 4431.6L1731.875 4434.6L1733.875 4436.6L1733.875 4439.6L1735.875 4441.6L1735.875 4444.6L1737.875 4446.6L1737.875 4449.6L1739.875 4451.6L1739.875 4454.6L1741.875 4456.6L1741.875 4459.6L1743.875 4461.6L1743.875 4464.6L1745.875 4466.6L1745.875 4469.6L1747.875 4471.6L1747.875 4474.6L1749.875 4476.6L1749.875 4479.6L1751.875 4481.6L1751.875 4484.6L1753.875 4486.6L1753.875 4489.6L1755.875 4491.6L1755.875 4494.6L1757.875 4496.6L1757.875 4499.6L1759.875 4501.6L1759.875 4504.6L1761.875 4506.6L1761.875 4509.6L1763.875 4511.6L1763.875 4514.6L1765.875 4516.6L1765.875 4519.6L1767.875 4521.6L1767.875 4524.6L1769.875 4526.6L1769.875 4529.6L1771.875 4531.6L1771.875 4534.6L1773.875 4536.6L1773.875 4539.6L1775.875 4541.6L1775.875 4544.6L1777.875 4546.6L1777.875 4549.6L1779.875 4551.6L1779.875 4554.6L1781.875 4556.6L1781.875 4559.6L1783.875 4561.6L1783.875 4564.6L1785.875 4566.6L1785.875 4569.6L1787.875 4571.6L1787.875 4574.6L1789.875 4576.6L1789.875 4579.6L1791.875 4581.6L1791.875 4584.6L1793.875 4586.6L1793.875 4589.6L1795.875 4591.6L1795.875 4594.6L1797.875 4596.6L1797.875 4599.6L1799.875 4601.6L1799.875 4604.6L1801.875 4606.6L1801.875 4609.6L1803.875 4611.6L1803.875 4614.6L1805.875 4616.6L1805.875 4619.6L1807.875 4621.6L1807.875 4624.6L1809.875 4626.6L1809.875 4629.6L1811.875 4631.6L1811.875 4634.6L1813.875 4636.6L1813.875 4639.6L1815.875 4641.6L1815.875 4644.6L1817.875 4646.6L1817.875 4649.6L1819.875 4651.6L1819.875 4654.6L1821.875 4656.6L1821.875 4659.6L1823.875 4661.6L1823.875 4664.6L1825.875 4666.6L1825.875 4669.6L1827.875 4671.6L1827.875 4674.6L1829.875 4676.6L1829.875 4679.6L1831.875 4681.6L1831.875 4684.6L1833.875 4686.6L1833.875 4689.6L1835.875 4691.6L1835.875 4694.6L1837.875 4696.6L1837.875 4699.6L1839.875 4701.6L1839.875 4704.6L1841.875 4706.6L1841.875 4709.6L1843.875 4711.6L1843.875 4714.6L1845.875 4716.6L1845.875 4719.6L1847.875 4721.6L1847.875 4724.6L1849.875 4726.6L1849.875 4729.6L1851.875 4731.6L1851.875 4734.6L1853.875 4736.6L1853.875 4739.6L1855.875 4741.6L1855.875 4744.6L1857.875 4746.6L1857.875 4749.6L1859.875 4751.6L1859.875 4754.6L1861.875 4756.6L1861.875 4759.6L1863.875 4761.6L1863.875 4764.6L1865.875 4766.6L1865.875 4769.6L1867.875 4771.6L1867.875 4774.6L1869.875 4776.6L1869.875 4779.6L1871.875 4781.6L1871.875 4784.6L1873.875 4786.6L1873.875 4789.6L1875.875 4791.6L1875.875 4794.6L1877.875 4796.6L1877.875 4799.6L1879.875 4801.6L1879.875 4804.6L1881.875 4806.6L1881.875 4809.6L1883.875 4811.6L1883.875 4814.6L1885.875 4816.6L1885.875 4819.6L1887.875 4821.6L1887.875 4824.6L1889.875 4826.6L1889.875 4829.6L1891.875 4831.6L1891.875 4834.6L1893.875 4836.6L1893.875 4839.6L1895.875 4841.6L1895.875 4844.6L1897.875 4846.6L1897.875 4849.6L1899.875 4851.6L1899.875 4854.6L1901.875 4856.6L1901.875 4859.6L1903.875 4861.6L1903.875 4864.6L1905.875 4866.6L1905.875 4869.6L1907.875 4871.6L1907.875 4874.6L1909.875 4876.6L1909.875 4879.6L1911.875 4881.6L1911.875 4884.6L1913.875 4886.6L1913.875 4889.6L1915.875 4891.6L1915.875 4894.6L1917.875 4896.6L1917.875 4899.6L1919.875 4901.6L1919.875 4904.6L1921.875 4906.6L1921.875 4909.6L1923.875 4911.6L1923.875 4914.6L1925.875 4916.6L1925.875 4919.6L1927.875 4921.6L1927.875 4924.6L1929.875 4926.6L1929.875 4929.6L1931.875 4931.6L1931.875 4934.6L1933.875 4936.6L1933.875 4939.6L1935.875 4941.6L1935.875 4944.6L1937.875 4946.6L1937.875 4949.6L1939.875 4951.6L1939.875 4954.6L1941.875 4956.6L1941.875 4959.6L1943.875 4961.6L1943.875 4964.6L1945.875 4966.6L1945.875 4969.6L1947.875 4971.6L1947.875 4974.6L1949.875 4976.6L1949.875 4979.6L1951.875 4981.6L1951.875 4984.6L1953.875 4986.6L1953.875 4989.6L1955.875 4991.6L1955.875 4994.6L1957.875 4996.6L1957.875 4999.6L1959.875 5001.6L1959.875 5004.6L1961.875 5006.6L1961.875 5009.6L1963.875 5011.6L1963.875 5014.6L1965.875 5016.6L1965.875 5019.6L1967.875 5021.6L1967.875 5024.6L1969.875 5026.6L1969.875 5029.6L1971.875 5031.6L1971.875 5034.6L1973.875 5036.6L1973.875 5039.6L1975.875 5041.6L1975.875 5044.6L1977.875 5046.6L1977.875 5049.6L1979.875 5051.6L1979.875 5054.6L1981.875 5056.6L1981.875 5059.6L1983.875 5061.6L1983.875 5064.6L1985.875 5066.6L1985.875 5069.6L1987.875 5071.6L1987.875 5074.6L1989.875 5076.6L1989.875 5079.6L1991.875 5081.6L1991.875 5084.6L1993.875 5086.6L1993.875 5089.6L1995.875 5091.6L1995.875 5094.6L1997.875 5096.6L1997.875 5099.6L1999.875 5101.6L1999.875 5104.6L2001.875 5106.6L2001.875 5109.6L2003.875 5111.6L2003.875 5114.6L2005.875 5116.6" stroke="%23641e17" stroke-width="0.2"/></svg>');
        }

        /* Progress circles for Hunter Ranks */
        .progress-circle {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--bg-color);
        }

        .progress-circle span {
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .achievement {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .achievement.unlocked {
            background-color: rgba(165, 24, 29, 0.2);
        }

        .achievement-icon {
            width: 30px;
            height: 30px;
            margin-right: 12px;
            opacity: 0.5;
        }

        .achievement.unlocked .achievement-icon {
            opacity: 1;
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-title {
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .boss-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }

        .boss-progress {
            width: 100%;
            margin-bottom: 16px;
        }

        /* Battle trophy styles */
        .trophy {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 4px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-left: 4px solid var(--primary-color);
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transform: translateX(120%);
            transition: transform 0.3s;
            z-index: 100;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Seasonal event banner */
        .seasonal-banner {
            background-color: rgba(165, 24, 29, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            border: 1px solid rgba(165, 24, 29, 0.5);
        }

        .seasonal-banner .banner-icon {
            margin-right: 12px;
            font-size: 24px;
        }
        
        /* Boss modifier badge */
        .boss-modifier {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(165, 24, 29, 0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 20px;
            margin-left: 8px;
            font-family: 'Cinzel', serif;
        }
        
        /* Auto-save indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: opacity 0.3s;
            opacity: 0;
            z-index: 50;
        }
        
        .autosave-indicator.show {
            opacity: 1;
        }
        
        .error-text {
            color: #f87171;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="dark min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 tracking-wider">
                <span class="text-red-700">Hunter's</span> Dream
            </h1>
            <p class="text-lg md:text-xl italic mb-4">A hunter must hunt, even in dreams...</p>
            
            <!-- Navigation Tabs -->
            <div class="flex justify-center space-x-4 mt-4 border-b border-gray-700">
                <div id="recordTab" class="tab active py-2 px-4 text-lg">Record Sleep</div>
                <div id="historyTab" class="tab py-2 px-4 text-lg">Sleep History</div>
                <div id="runesTab" class="tab py-2 px-4 text-lg">Runes & Chalices</div>
                <div id="settingsTab" class="tab py-2 px-4 text-lg">Settings</div>
            </div>
        </header>

        <!-- Record Sleep View -->
        <div id="recordView" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card gothic-border rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-6 border-b border-red-900 pb-2">Record Your Slumber</h2>
                
                <form id="sleepForm" class="space-y-4">
                    <div>
                        <label class="block mb-1">Date</label>
                        <input type="date" id="sleepDate" class="w-full p-2 rounded text-base" required>
                        <p id="dateDuplicateError" class="error-text hidden">You already have a record for this date. Please choose another date or delete the existing record first.</p>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-xl mb-3">Sleep Phases (minutes)</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-1">Awake Time</label>
                                <input type="number" id="awakeTime" min="0" max="480" class="w-full p-2 rounded text-base sleep-phase-input" required>
                            </div>
                            
                            <div>
                                <label class="block mb-1">REM Sleep</label>
                                <input type="number" id="remSleep" min="0" max="480" class="w-full p-2 rounded text-base sleep-phase-input" required>
                            </div>
                            
                            <div>
                                <label class="block mb-1">Light Sleep</label>
                                <input type="number" id="lightSleep" min="0" max="480" class="w-full p-2 rounded text-base sleep-phase-input" required>
                            </div>
                            
                            <div>
                                <label class="block mb-1">Deep Sleep</label>
                                <input type="number" id="deepSleep" min="0" max="480" class="w-full p-2 rounded text-base sleep-phase-input" required>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block mb-1">Total Sleep Duration (hours)</label>
                        <input type="number" id="totalSleep" min="0" max="24" step="0.1" class="w-full p-2 rounded text-base bg-gray-200 dark:bg-gray-800" readonly>
                        <p class="text-sm text-gray-500 mt-1">Total sleep is automatically calculated from the minutes above</p>
                    </div>
                    
                    <button type="submit" class="blood-btn w-full py-3 px-4 text-white rounded-lg font-bold tracking-wider text-lg transform transition hover:scale-105">
                        TRANSCRIBE DREAM
                    </button>
                </form>
            </div>
            
            <!-- Results Section -->
            <div class="card gothic-border rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-6 border-b border-red-900 pb-2">Dream Analysis</h2>
                
                <div id="resultsContent" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-opacity-20 bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl mb-2">Sleep Score</h3>
                            <div class="relative pt-1">
                                <div class="flex mb-2 items-center justify-between">
                                    <div>
                                        <span id="sleepScoreValue" class="text-3xl font-semibold inline-block">0</span>
                                        <span class="text-xl">/100</span>
                                    </div>
                                </div>
                                <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-gray-700">
                                    <div id="sleepScoreBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-900" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-opacity-20 bg-gray-800 p-4 rounded-lg">
                            <h3 class="text-xl mb-2">Blood Echoes Earned</h3>
                            <div class="flex items-center">
                                <div class="blood-icon mr-2"></div>
                                <span id="bloodEchoesValue" class="text-3xl font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-opacity-20 bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl mb-4">Sleep Phases</h3>
                        <div class="w-full h-60">
                            <canvas id="sleepPhasesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-opacity-20 bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl mb-2">Insights</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-lg">Total Sleep:</p>
                                <p id="totalSleepDisplay" class="text-2xl font-semibold">0 hours</p>
                            </div>
                            <div>
                                <p class="text-lg">Insight Gained:</p>
                                <p id="insightValue" class="text-2xl font-semibold">0</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p id="sleepAnalysis" class="italic text-gray-400"></p>
                        </div>
                    </div>

                    <!-- Hunter Stats Section -->
                    <div class="bg-opacity-20 bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl">Hunter Stats</h3>
                            <div class="flex items-center">
                                <span class="mr-2">Rank:</span>
                                <span id="hunterRank" class="hunter-rank">Waking Hunter I</span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div>
                                <p>Total Blood Echoes:</p>
                                <div class="flex items-center">
                                    <div class="blood-icon mr-2"></div>
                                    <span id="totalBloodEchoes" class="text-xl font-semibold">0</span>
                                </div>
                            </div>
                            <div>
                                <p>Total Insight:</p>
                                <span id="totalInsight" class="text-xl font-semibold">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Save Button -->
                    <button id="manualSaveBtn" class="secondary-btn py-2 px-4 text-white rounded mt-4 w-full">
                        Save Progress
                    </button>
                </div>
                
                <div id="noResultsContent" class="flex flex-col items-center justify-center h-full">
                    <p class="text-xl text-center italic text-gray-500 mt-4 mb-8">
                        Record your nightly slumber to receive the Hunter's wisdom...
                    </p>
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNjQxZTE3IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgY2xhc3M9ImZlYXRoZXIgZmVhdGhlci1tb29uIj48cGF0aCBkPSJNMjEgMTIuNzlBOSA5IDAgMSAxIDExLjIxIDMgNyA3IDAgMCAwIDIxIDEyLjc5eiI+PC9wYXRoPjwvc3ZnPg==" 
                         alt="Moon icon" class="w-24 h-24 opacity-40">
                </div>
            </div>
        </div>

        <!-- Sleep History View -->
        <div id="historyView" class="hidden">
            <div class="card gothic-border rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-6 border-b border-red-900 pb-2">Sleep History</h2>
                
                <!-- Seasonal Hunt Banner -->
                <div id="seasonalBanner" class="seasonal-banner mb-6" style="display: none;">
                    <!-- Content will be set dynamically -->
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl mb-4">Weekly Sleep Scores</h3>
                    <div class="w-full h-80">
                        <canvas id="weeklyScoreChart"></canvas>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl mb-4">Sleep Consistency</h3>
                    <div class="w-full h-80">
                        <canvas id="sleepConsistencyChart"></canvas>
                    </div>
                </div>

                <!-- Current Boss Battle / Weekly Challenge -->
                <div id="bossCard" class="mt-8 p-6 rounded-lg gothic-border">
                    <h3 class="text-2xl font-bold mb-4 text-red-700">This Week's Boss Battle</h3>
                    <div class="flex items-center mb-4">
                        <div class="w-16 h-16 flex items-center justify-center mr-4 opacity-80">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#a5181d" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2a10 10 0 1 0 0 20 10 10 0 1 0 0-20z"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                        </div>
                        <div>
                            <h4 id="bossName" class="text-xl font-bold mb-1">Father Consistent</h4>
                            <p id="bossDescription" class="text-gray-400">Get at least 7 hours of sleep for 5 consecutive nights</p>
                        </div>
                    </div>
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span id="bossProgress" class="text-base font-semibold inline-block">0/5 nights</span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-4 mb-4 text-xs flex rounded bg-gray-800">
                            <div id="bossProgressBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-900" style="width: 0%"></div>
                        </div>
                    </div>
                    <p class="text-sm italic text-gray-500">Reward: 5000 Blood Echoes + Deep Sleep Rune</p>

                    <!-- Boss Battle History -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <h4 class="font-bold mb-2">Vanquished Bosses</h4>
                        <div class="flex flex-wrap">
                            <div id="bossTrophyContainer" class="flex flex-wrap">
                                <!-- Boss trophies will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Records Table -->
                <div class="mt-8">
                    <h3 class="text-xl mb-4">Recent Records</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 text-left">Date</th>
                                    <th class="py-2 px-4 text-left">Score</th>
                                    <th class="py-2 px-4 text-left">Hours</th>
                                    <th class="py-2 px-4 text-left">Blood Echoes</th>
                                    <th class="py-2 px-4 text-left">Insight</th>
                                    <th class="py-2 px-4 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Runes & Chalices View -->
        <div id="runesView" class="hidden">
            <div class="card gothic-border rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-2 border-b border-red-900 pb-2">Runes & Chalices</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <!-- Runes Section -->
                    <div>
                        <h3 class="text-xl mb-4 text-red-700">Caryll Runes</h3>
                        <p class="text-sm mb-6 text-gray-400">Runes are transcriptions of inhuman utterings that offer hunters special boosts</p>
                        
                        <div class="space-y-4">
                            <div class="flex flex-wrap gap-4">
                                <div class="rune" id="rune-moon" title="Moon Rune: +10% Blood Echoes">M</div>
                                <div class="rune" id="rune-great-lake" title="Great Lake Rune: +20% maximum Insight">L</div>
                                <div class="rune" id="rune-anti-clockwise" title="Anti-Clockwise Rune: Improved sleep consistency">A</div>
                                <div class="rune" id="rune-deep" title="Deep Sleep Rune: +15% Deep Sleep efficiency">D</div>
                                <div class="rune" id="rune-clarity" title="Clarity Rune: +20% REM sleep efficiency">C</div>
                                <div class="rune" id="rune-communion" title="Communion Rune: +30% Blood Echoes on weekends">O</div>
                                <div class="rune" id="rune-beast" title="Beast Rune: Recovery bonus after poor sleep">B</div>
                            </div>
                            
                            <div id="runeDescription" class="mt-4 p-4 bg-opacity-20 bg-gray-800 rounded-lg">
                                <h4 class="font-bold">Select a rune to see its details</h4>
                                <p class="text-gray-400 mt-2">Runes are unlocked by meeting specific sleep achievements</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chalice Dungeons Section -->
                    <div>
                        <h3 class="text-xl mb-4 text-red-700">Chalice Dungeons</h3>
                        <p class="text-sm mb-6 text-gray-400">Special achievements reached through consistent sleep patterns</p>
                        
                        <div class="space-y-2">
                            <div class="achievement" id="chalice-1">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Pthumeru Chalice</h4>
                                    <p class="text-sm text-gray-400">Achieve a sleep score above 85 for 3 consecutive nights</p>
                                </div>
                            </div>
                            
                            <div class="achievement" id="chalice-2">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Central Pthumeru Chalice</h4>
                                    <p class="text-sm text-gray-400">Maintain a consistent sleep schedule (30 min) for a week</p>
                                </div>
                            </div>
                            
                            <div class="achievement" id="chalice-3">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Lower Pthumeru Chalice</h4>
                                    <p class="text-sm text-gray-400">Achieve at least 90 minutes of deep sleep for 5 nights</p>
                                </div>
                            </div>
                            
                            <div class="achievement" id="chalice-4">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Defiled Chalice</h4>
                                    <p class="text-sm text-gray-400">Recover from sleep debt by sleeping 9+ hours after 5 poor nights</p>
                                </div>
                            </div>
                            
                            <div class="achievement" id="chalice-5">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Great Pthumeru Ihyll Chalice</h4>
                                    <p class="text-sm text-gray-400">Maintain excellent sleep (score 90+) for 2 straight weeks</p>
                                </div>
                            </div>

                            <div class="achievement" id="chalice-6">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Isz Chalice</h4>
                                    <p class="text-sm text-gray-400">Achieve 150+ minutes of REM sleep for 3 nights</p>
                                </div>
                            </div>

                            <div class="achievement" id="chalice-7">
                                <div class="achievement-icon"></div>
                                <div>
                                    <h4 class="font-bold">Hintertomb Chalice</h4>
                                    <p class="text-sm text-gray-400">Achieve a perfect 100 sleep score</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hunter Rank Progress -->
                <div class="mt-8">
                    <h3 class="text-xl mb-4 text-red-700">Hunter Rank Progress</h3>
                    <div class="flex items-center justify-between mb-2">
                        <span id="currentRank">Waking Hunter I</span>
                        <span id="nextRank">Waking Hunter II</span>
                    </div>
                    <div class="relative pt-1">
                        <div class="overflow-hidden h-4 mb-2 text-xs flex rounded bg-gray-700">
                            <div id="rankProgressBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-red-900" style="width: 0%"></div>
                        </div>
                        <div class="text-right">
                            <span id="rankProgressText">0 / 100,000 Blood Echoes</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-2 md:grid-cols-6 gap-4">
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>I</span>
                            </div>
                            <p class="mt-2 text-sm">Waking Hunter</p>
                        </div>
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>II</span>
                            </div>
                            <p class="mt-2 text-sm">Dream Hunter</p>
                        </div>
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>III</span>
                            </div>
                            <p class="mt-2 text-sm">Nightmare Hunter</p>
                        </div>
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>IV</span>
                            </div>
                            <p class="mt-2 text-sm">Blood-Drunk Hunter</p>
                        </div>
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>V</span>
                            </div>
                            <p class="mt-2 text-sm">Great One</p>
                        </div>
                        <div class="text-center">
                            <div class="progress-circle mx-auto" style="background: conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)">
                                <span>VI</span>
                            </div>
                            <p class="mt-2 text-sm">Elder Great One</p>
                        </div>
                    </div>

                    <!-- Achievement Information -->
                    <div class="mt-8 p-4 bg-opacity-20 bg-gray-800 rounded-lg">
                        <h4 class="font-bold mb-2">Achievement Progress</h4>
                        <p class="text-sm text-gray-400 mb-4">Defeat bosses and maintain excellent sleep to unlock all runes and chalices</p>
                        <div class="flex items-center justify-between">
                            <span>Runes Unlocked: <span id="runesUnlockedCount">0/7</span></span>
                            <span>Chalices Unlocked: <span id="chalicesUnlockedCount">0/7</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="hidden">
            <div class="card gothic-border rounded-lg p-6">
                <h2 class="text-2xl font-bold mb-6 border-b border-red-900 pb-2">Settings</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Data Management Section -->
                    <div>
                        <h3 class="text-xl mb-4 text-red-700">Data Management</h3>
                        
                        <div class="space-y-4">
                            <!-- Manual save -->
                            <div>
                                <h4 class="font-bold mb-2">Manual Save</h4>
                                <p class="text-sm mb-4">Save your progress manually (automatic saves occur every 30 seconds)</p>
                                <button id="settingsSaveBtn" class="secondary-btn py-2 px-4 text-white rounded">
                                    Save Progress
                                </button>
                            </div>
                            
                            <!-- Export Data -->
                            <div class="mt-6">
                                <h4 class="font-bold mb-2">Export Your Data</h4>
                                <p class="text-sm mb-4">Copy your sleep data to save it or transfer to another device</p>
                                <button id="exportDataBtn" class="secondary-btn py-2 px-4 text-white rounded">
                                    Export Data
                                </button>
                            </div>
                            
                            <!-- Import Data -->
                            <div class="mt-6">
                                <h4 class="font-bold mb-2">Import Data</h4>
                                <p class="text-sm mb-4">Paste previously exported data to restore your progress</p>
                                <textarea id="importData" rows="5" class="w-full p-2 rounded text-base mb-2" placeholder="Paste your exported data here..."></textarea>
                                <button id="importDataBtn" class="secondary-btn py-2 px-4 text-white rounded">
                                    Import Data
                                </button>
                            </div>
                            
                            <!-- Reset Progress -->
                            <div class="mt-8 pt-4 border-t border-gray-700">
                                <h4 class="font-bold mb-2">Reset Progress</h4>
                                <p class="text-sm mb-4 text-red-400">Warning: This will erase all your data and cannot be undone!</p>
                                <button id="resetProgressBtn" class="danger-btn py-2 px-4 text-white rounded">
                                    Hard Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preferences Section -->
                    <div>
                        <h3 class="text-xl mb-4 text-red-700">Preferences</h3>
                        
                        <div class="space-y-4">
                            <!-- Theme Preference -->
                            <div>
                                <h4 class="font-bold mb-2">Theme</h4>
                                <div class="flex space-x-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="theme" value="system" checked class="form-radio h-5 w-5">
                                        <span class="ml-2">System</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="theme" value="dark" class="form-radio h-5 w-5">
                                        <span class="ml-2">Dark</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="theme" value="light" class="form-radio h-5 w-5">
                                        <span class="ml-2">Light</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Notifications -->
                            <div class="mt-4">
                                <h4 class="font-bold mb-2">Notifications</h4>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="showNotifications" checked class="form-checkbox h-5 w-5">
                                    <span class="ml-2">Show achievement notifications</span>
                                </label>
                            </div>
                            
                            <!-- Help & Information -->
                            <div class="mt-8 pt-4 border-t border-gray-700">
                                <h4 class="font-bold mb-2">About</h4>
                                <p class="text-sm mb-1">Hunter's Dream Sleep Tracker - v1.4.0</p>
                                <p class="text-sm mb-3">A Bloodborne-themed sleep tracking application to gamify your sleep habits.</p>
                                <p class="text-sm mb-3">This is a fan project created for educational and entertainment purposes only, not for commercial use or profit.</p>
                                <p class="text-sm">Questions or suggestions? Contact the developer at <a href="mailto:ryuga.ichi@gmail.com" class="text-red-500 hover:underline">ryuga.ichi@gmail.com</a></p>
                                
                                <button id="howToPlayBtn" class="secondary-btn py-2 px-4 text-white rounded mt-4">
                                    How to Play
                                </button>
                            </div>
                            
                            <!-- Support Developer -->
                            <div class="mt-6 pt-4 border-t border-gray-700">
                                <h4 class="font-bold mb-2">Support the Developer</h4>
                                <p class="text-sm mb-3">If you enjoy Hunter's Dream, consider supporting the developer:</p>
                                <div class="flex space-x-2">
                                    <a href="https://ko-fi.com/cygryu" target="_blank" class="blood-btn py-2 px-4 text-white rounded flex-1 text-center">
                                        Ko-Fi
                                    </a>
                                    <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="secondary-btn py-2 px-4 text-white rounded flex-1 text-center">
                                        PayPal
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4 mt-8 text-gray-500 text-sm">
        <p>Developed by CygRyu | &copy; 2025 Hunter's Dream</p>
    </footer>

    <!-- Modal Overlays -->
    <!-- Reset Confirmation Modal -->
    <div id="resetConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" id="resetModalClose"></div>
            <h3 class="modal-title text-2xl text-red-700">Confirm Reset</h3>
            <p class="mb-4">Are you sure you want to reset all progress? This action cannot be undone.</p>
            <p class="mb-6 text-sm italic">All sleep records, achievements, runes, and hunter stats will be permanently erased.</p>
            <div class="flex space-x-4">
                <button id="cancelResetBtn" class="secondary-btn py-2 px-4 text-white rounded w-1/2">
                    Cancel
                </button>
                <button id="confirmResetBtn" class="danger-btn py-2 px-4 text-white rounded w-1/2">
                    Reset Everything
                </button>
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="exportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" id="exportModalClose"></div>
            <h3 class="modal-title text-2xl text-red-700">Export Data</h3>
            <p class="mb-4">Copy the text below to save your data:</p>
            <textarea id="exportDataText" rows="10" class="w-full p-2 rounded text-base mb-4" readonly></textarea>
            <button id="copyExportBtn" class="blood-btn py-2 px-4 text-white rounded w-full">
                Copy to Clipboard
            </button>
        </div>
    </div>

    <!-- How to Play Modal -->
    <div id="howToPlayModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" id="howToPlayModalClose"></div>
            <h3 class="modal-title text-2xl text-red-700">How to Play</h3>
            <div class="overflow-y-auto max-h-96">
                <p class="mb-4">Welcome to Hunter's Dream, a sleep tracker that transforms your sleep habits into a Bloodborne-inspired game!</p>
                
                <h4 class="font-bold mt-4 mb-2">Getting Started</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li>Record your sleep data (duration, phases) daily</li>
                    <li>Earn Blood Echoes based on sleep quality</li>
                    <li>Gain Insight from REM sleep</li>
                    <li>Track your sleep consistency in the History tab</li>
                </ul>
                
                <h4 class="font-bold mt-4 mb-2">Game Features</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li><b>Hunter Ranks:</b> Progress through 6 ranks from Waking Hunter to Elder Great One</li>
                    <li><b>Caryll Runes:</b> Unlock and upgrade powerful runes using Insight to enhance sleep benefits</li>
                    <li><b>Procedural Bosses:</b> Face randomized boss challenges with unique modifiers</li>
                    <li><b>Chalice Dungeons:</b> Complete difficult sleep challenges</li>
                    <li><b>Boss Battles:</b> Weekly challenges with unique rewards</li>
                    <li><b>Seasonal Events:</b> Limited-time challenges with exclusive rewards</li>
                </ul>
                
                <h4 class="font-bold mt-4 mb-2">Rune Enhancement System</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li>Unlock runes by meeting specific sleep criteria and defeating bosses</li>
                    <li>Spend Insight to upgrade runes from Level I to III</li>
                    <li>Higher level runes provide stronger benefits (e.g., Moon Rune I gives +10% echoes, Moon Rune III gives +25%)</li>
                    <li>Strategically choose which runes to upgrade based on your sleeping patterns</li>
                </ul>
                
                <h4 class="font-bold mt-4 mb-2">Boss Battle System</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li>Face random boss challenges each week with varied requirements</li>
                    <li>Boss modifiers add unique challenges (Frenzied, Cursed, Undying, etc.)</li>
                    <li>Defeat bosses to earn Blood Echoes and unlock special runes</li>
                    <li>Collect boss trophies to display your victories</li>
                </ul>
                
                <h4 class="font-bold mt-4 mb-2">Saving Your Progress</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li>Progress is automatically saved to your browser's storage every 30 seconds</li>
                    <li>Use the "Save Progress" button for manual saves</li>
                    <li>Export your data regularly as backup</li>
                </ul>
                
                <h4 class="font-bold mt-4 mb-2">Tips for Success</h4>
                <ul class="list-disc pl-5 mb-4 space-y-2">
                    <li>Maintain consistent sleep and wake times</li>
                    <li>Aim for 7-9 hours of sleep each night</li>
                    <li>Focus on increasing deep sleep and REM sleep</li>
                    <li>Complete boss battles for valuable rewards</li>
                    <li>Strategically spend Insight on rune upgrades that match your sleep patterns</li>
                </ul>
            </div>
            <button id="closeHowToPlayBtn" class="blood-btn py-2 px-4 text-white rounded w-full mt-4">
                Begin the Hunt
            </button>
        </div>
    </div>

    <!-- New Boss Modal -->
    <div id="newBossModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" id="newBossModalClose"></div>
            <h3 class="modal-title text-2xl text-red-700">New Boss Battle Available</h3>
            <div class="flex items-center mb-6 mt-4">
                <div class="boss-icon mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <line x1="10" y1="9" x2="8" y2="9"></line>
                    </svg>
                </div>
                <div>
                    <h4 id="newBossName" class="text-xl font-bold">Vicar REM</h4>
                    <p id="newBossDescription" class="text-gray-400">Achieve at least 120 minutes of REM sleep for 3 consecutive nights</p>
                </div>
            </div>
            <p class="mb-4">A new challenge awaits in the Hunter's Dream! Defeat this boss to earn valuable rewards.</p>
            <div class="bg-opacity-20 bg-gray-800 p-3 rounded-lg mb-4">
                <h5 class="font-bold mb-1">Rewards:</h5>
                <ul class="list-disc pl-5">
                    <li id="newBossReward1">7,500 Blood Echoes</li>
                    <li id="newBossReward2">Clarity Rune - Increases REM sleep efficiency</li>
                </ul>
            </div>
            <button id="acceptBossBtn" class="blood-btn py-2 px-4 text-white rounded w-full">
                Accept the Hunt
            </button>
        </div>
    </div>

    <!-- Confirm Record Delete Modal -->
    <div id="deleteRecordModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" id="deleteRecordModalClose"></div>
            <h3 class="modal-title text-2xl text-red-700">Delete Sleep Record</h3>
            <p class="mb-4">Are you sure you want to delete this sleep record? This action cannot be undone.</p>
            <p id="deleteRecordDetails" class="mb-6 text-sm italic">Date: N/A</p>
            <div class="flex space-x-4">
                <button id="cancelDeleteBtn" class="secondary-btn py-2 px-4 text-white rounded w-1/2">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="danger-btn py-2 px-4 text-white rounded w-1/2">
                    Delete Record
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification">
        <h4 id="notificationTitle" class="font-bold mb-1">Achievement Unlocked</h4>
        <p id="notificationMessage">You've earned a new rune!</p>
    </div>

    <!-- Auto-save Indicator -->
    <div id="autosaveIndicator" class="autosave-indicator">
        Auto-saving...
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        });

        // Application state
        let sleepRecords = [];
        let totalBloodEchoes = 0;
        let totalInsight = 0;
        let weeklyScoreChart;
        let sleepConsistencyChart;
        let sleepPhasesChart;
        let currentHunterRank = 0;
        let bossesDefeated = [];
        let currentSeasonalEvent = null;
        
        // Seasonal events data
        const seasonalEvents = [
            {
                id: "hunters_moon",
                name: "Hunter's Moon Festival",
                icon: "",
                description: "The veil is thin! Complete this month's special hunts for limited runes and chalices.",
                rewardDescription: "Blood Moon Chalice - Restores deep sleep after poor nights"
            },
            {
                id: "winter_lantern",
                name: "Winter Lantern Solstice",
                icon: "",
                description: "Coldest night of the year! Maintain consistent sleep through the long night.",
                rewardDescription: "Frostbite Rune - +15% Blood Echoes during winter months"
            },
            {
                id: "blood_ministration",
                name: "Blood Ministration Day",
                icon: "",
                description: "The Great Ones demand tribute! Achieve 5 consecutive nights of 8+ hours sleep.",
                rewardDescription: "Old Blood Chalice - Increases deep sleep recovery rate"
            },
            {
                id: "amygdala_ascension",
                name: "Amygdala Ascension",
                icon: "",
                description: "The cosmos calls! Achieve 150+ minutes of REM sleep for 3 consecutive nights.",
                rewardDescription: "Cosmic Eye Rune - Increases Insight from dreams by 25%"
            },
            {
                id: "paleblood_hunt",
                name: "Paleblood Hunt",
                icon: "",
                description: "The hunt is on! Track your sleep for 7 consecutive days without missing a night.",
                rewardDescription: "Hunter's Badge - Provides bonus Blood Echoes for perfect attendance"
            }
        ];
        
        // Boss system data
        const bossTemplates = [
            {
                id: "father_consistent",
                name: "Father Consistent",
                description: "Get at least {TARGET_HOURS} hours of sleep for {TARGET_NIGHTS} consecutive nights",
                targetHours: 7,
                targetNights: 5,
                checkCondition: (record, hours) => record.totalSleep >= hours,
                baseEchoesReward: 5000,
                runeReward: "rune-deep"
            },
            {
                id: "vicar_rem",
                name: "Vicar REM",
                description: "Achieve at least {TARGET_MINS} minutes of REM sleep for {TARGET_NIGHTS} consecutive nights",
                targetMins: 120,
                targetNights: 3,
                checkCondition: (record, mins) => record.remSleep >= mins,
                baseEchoesReward: 7500,
                runeReward: "rune-clarity"
            },
            {
                id: "cleric_beast",
                name: "Cleric Beast",
                description: "Achieve a sleep score of {TARGET_SCORE}+ for {TARGET_NIGHTS} consecutive nights",
                targetScore: 80,
                targetNights: 3,
                checkCondition: (record, score) => record.sleepScore >= score,
                baseEchoesReward: 3000,
                runeReward: "rune-anti-clockwise"
            },
            {
                id: "blood_starved_beast",
                name: "Blood-Starved Beast",
                description: "Sleep at least {TARGET_HOURS} hours for {TARGET_NIGHTS} consecutive nights",
                targetHours: 8.5,
                targetNights: 3,
                checkCondition: (record, hours) => record.totalSleep >= hours,
                baseEchoesReward: 8000,
                runeReward: "rune-beast"
            },
            {
                id: "martyr_logarius",
                name: "Martyr Logarius",
                description: "Achieve at least {TARGET_MINS} minutes of Deep Sleep for {TARGET_NIGHTS} consecutive nights",
                targetMins: 100,
                targetNights: 4,
                checkCondition: (record, mins) => record.deepSleep >= mins,
                baseEchoesReward: 10000,
                runeReward: null
            },
            {
                id: "rom_vacuous",
                name: "Rom, the Vacuous Spider",
                description: "Maintain a consistent bedtime (20 min) for {TARGET_NIGHTS} consecutive nights",
                targetNights: 4,
                targetMins: 20, // This is the permitted variance in minutes
                checkCondition: (record, mins, prevRecord) => {
                    if (!prevRecord) return true; // First record automatically passes
                    // Estimate bedtime based on wake time and sleep duration
                    const date1 = new Date(record.date);
                    const date2 = new Date(prevRecord.date);
                    const timeDiffMinutes = Math.abs(
                        (date1.getHours() * 60 + date1.getMinutes()) - 
                        (date2.getHours() * 60 + date2.getMinutes())
                    );
                    return timeDiffMinutes <= mins;
                },
                baseEchoesReward: 6500,
                runeReward: null
            },
            {
                id: "darkbeast_paarl",
                name: "Darkbeast Paarl",
                description: "Have less than {TARGET_MINS} minutes of awake time for {TARGET_NIGHTS} consecutive nights",
                targetMins: 15,
                targetNights: 3,
                checkCondition: (record, mins) => record.awakeTime <= mins,
                baseEchoesReward: 8500,
                runeReward: null
            },
            {
                id: "shadows_yharnam",
                name: "Shadows of Yharnam",
                description: "Balance your sleep phases (20%+ Deep, 20%+ REM) for {TARGET_NIGHTS} nights",
                targetNights: 3,
                checkCondition: (record) => {
                    const totalSleepMins = record.remSleep + record.lightSleep + record.deepSleep;
                    const deepSleepPercent = record.deepSleep / totalSleepMins;
                    const remSleepPercent = record.remSleep / totalSleepMins;
                    return deepSleepPercent >= 0.2 && remSleepPercent >= 0.2;
                },
                baseEchoesReward: 7200,
                runeReward: null
            },
            {
                id: "amygdala",
                name: "Amygdala",
                description: "Achieve {TARGET_SCORE}+ sleep score with {TARGET_MINS}+ minutes of REM sleep",
                targetScore: 85,
                targetMins: 140,
                targetNights: 2,
                checkCondition: (record, params) => record.sleepScore >= params.score && record.remSleep >= params.mins,
                baseEchoesReward: 9000,
                runeReward: null
            },
            {
                id: "micolash",
                name: "Micolash, Host of the Nightmare",
                description: "Get a sleep score improvement of 20+ points compared to your previous night for {TARGET_NIGHTS} times",
                targetNights: 2,
                checkCondition: (record, _, prevRecord) => {
                    if (!prevRecord) return false;
                    return record.sleepScore >= prevRecord.sleepScore + 20;
                },
                baseEchoesReward: 8800,
                runeReward: null
            }
        ];
        
        // Boss modifiers
        const bossModifiers = [
            {
                id: "frenzied",
                name: "Frenzied",
                description: "Increases target values by 20%",
                applyModifier: (boss) => {
                    const modified = {...boss};
                    if (modified.targetHours) modified.targetHours *= 1.2;
                    if (modified.targetMins) modified.targetMins *= 1.2;
                    if (modified.targetScore) modified.targetScore = Math.min(100, Math.floor(modified.targetScore * 1.2));
                    modified.baseEchoesReward = Math.floor(modified.baseEchoesReward * 1.4);
                    return modified;
                }
            },
            {
                id: "cursed",
                name: "Cursed",
                description: "Requires one additional consecutive night",
                applyModifier: (boss) => {
                    const modified = {...boss};
                    modified.targetNights += 1;
                    modified.baseEchoesReward = Math.floor(modified.baseEchoesReward * 1.3);
                    return modified;
                }
            },
            {
                id: "rapid",
                name: "Rapid",
                description: "Must be completed within half the usual time",
                applyModifier: (boss) => {
                    const modified = {...boss};
                    modified.targetNights = Math.max(2, Math.floor(modified.targetNights / 2));
                    modified.baseEchoesReward = Math.floor(modified.baseEchoesReward * 1.2);
                    return modified;
                }
            },
            {
                id: "undying",
                name: "Undying",
                description: "Progress doesn't reset on failure, but requirements are tougher",
                applyModifier: (boss) => {
                    const modified = {...boss};
                    if (modified.targetHours) modified.targetHours *= 1.1;
                    if (modified.targetMins) modified.targetMins *= 1.1;
                    if (modified.targetScore) modified.targetScore = Math.min(100, Math.ceil(modified.targetScore * 1.1));
                    modified.noReset = true; // Special flag to prevent progress reset
                    return modified;
                }
            },
            {
                id: "arcane",
                name: "Arcane",
                description: "Double Insight reward but requirements are much higher",
                applyModifier: (boss) => {
                    const modified = {...boss};
                    if (modified.targetHours) modified.targetHours *= 1.3;
                    if (modified.targetMins) modified.targetMins *= 1.3;
                    if (modified.targetScore) modified.targetScore = Math.min(100, Math.floor(modified.targetScore * 1.3));
                    modified.insightMultiplier = 2;
                    return modified;
                }
            }
        ];
        
        // Current boss battle state
        let currentBossProgress = 0;
        let currentBossTarget = 5;
        let currentBossId = null;
        let currentBossData = null;
        
        // Rune system data
        const runeData = {
            'rune-moon': {
                title: "Moon Rune",
                levels: [
                    { level: 1, bonus: 10, cost: 0, description: "Increases Blood Echoes gained from sleep by 10%." },
                    { level: 2, bonus: 15, cost: 20, description: "Increases Blood Echoes gained from sleep by 15%." },
                    { level: 3, bonus: 25, cost: 50, description: "Increases Blood Echoes gained from sleep by 25%." }
                ],
                unlockCondition: "Accumulate 50,000 Blood Echoes total."
            },
            'rune-great-lake': {
                title: "Great Lake Rune",
                levels: [
                    { level: 1, bonus: 20, cost: 0, description: "Increases Insight gained from REM sleep by 20%." },
                    { level: 2, bonus: 30, cost: 25, description: "Increases Insight gained from REM sleep by 30%." },
                    { level: 3, bonus: 45, cost: 60, description: "Increases Insight gained from REM sleep by 45%." }
                ],
                unlockCondition: "Collect 25 Insight points total."
            },
            'rune-anti-clockwise': {
                title: "Anti-Clockwise Rune",
                levels: [
                    { level: 1, bonus: 5, cost: 0, description: "Reduces Sleep Score penalties from irregular sleep timing. +5 score bonus for consistent sleep." },
                    { level: 2, bonus: 8, cost: 15, description: "Improved consistency bonus. +8 score bonus for consistent sleep." },
                    { level: 3, bonus: 12, cost: 40, description: "Superior consistency tracking. +12 score bonus for consistent sleep." }
                ],
                unlockCondition: "Defeat the Cleric Beast boss."
            },
            'rune-deep': {
                title: "Deep Sleep Rune",
                levels: [
                    { level: 1, bonus: 15, cost: 0, description: "Increases the value of Deep Sleep by 15%." },
                    { level: 2, bonus: 25, cost: 20, description: "Increases the value of Deep Sleep by 25%." },
                    { level: 3, bonus: 40, cost: 50, description: "Increases the value of Deep Sleep by 40%." }
                ],
                unlockCondition: "Defeat Father Consistent boss or achieve 90+ minutes of Deep Sleep for 3 nights."
            },
            'rune-clarity': {
                title: "Clarity Rune",
                levels: [
                    { level: 1, bonus: 20, cost: 0, description: "Increases the value of REM sleep by 20%." },
                    { level: 2, bonus: 30, cost: 25, description: "Increases the value of REM sleep by 30%." },
                    { level: 3, bonus: 45, cost: 55, description: "Increases the value of REM sleep by 45%." }
                ],
                unlockCondition: "Defeat Vicar REM boss."
            },
            'rune-communion': {
                title: "Communion Rune",
                levels: [
                    { level: 1, bonus: 30, cost: 0, description: "Increases Blood Echoes gained on weekends by 30%." },
                    { level: 2, bonus: 45, cost: 30, description: "Increases Blood Echoes gained on weekends by 45%." },
                    { level: 3, bonus: 60, cost: 65, description: "Increases Blood Echoes gained on weekends by 60%." }
                ],
                unlockCondition: "Record 10 nights of sleep data."
            },
            'rune-beast': {
                title: "Beast Rune",
                levels: [
                    { level: 1, bonus: 20, cost: 0, description: "Provides a 20% recovery bonus after multiple poor sleep nights." },
                    { level: 2, bonus: 35, cost: 20, description: "Provides a 35% recovery bonus after multiple poor sleep nights." },
                    { level: 3, bonus: 50, cost: 45, description: "Provides a 50% recovery bonus after multiple poor sleep nights." }
                ],
                unlockCondition: "Defeat the Blood-Starved Beast boss."
            }
        };
        
        // Track rune levels
        let runeLevels = {};
        
        // Initialize with today's date
        document.getElementById('sleepDate').valueAsDate = new Date();
        
        // Auto-save timer
        let autoSaveTimer = null;
        
        // Load saved data or use empty data if none exists
        loadSavedData();
        
        // Setup auto-save every 30 seconds
        startAutoSave();
        
        // Auto-calculate total sleep from phases
        setupSleepPhaseCalculation();
        
        // Navigation between tabs
        document.getElementById('recordTab').addEventListener('click', function() {
            setActiveTab('recordTab');
            document.getElementById('recordView').classList.remove('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('runesView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');
        });
        
        document.getElementById('historyTab').addEventListener('click', function() {
            setActiveTab('historyTab');
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('historyView').classList.remove('hidden');
            document.getElementById('runesView').classList.add('hidden');
            document.getElementById('settingsView').classList.add('hidden');
            
            // Initialize charts when history tab is shown
            initializeHistoryCharts();
            populateHistoryTable();
            updateBossProgress();
            updateBossTrophies();
            updateSeasonalEvent();
        });
        
        document.getElementById('runesTab').addEventListener('click', function() {
            setActiveTab('runesTab');
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('runesView').classList.remove('hidden');
            document.getElementById('settingsView').classList.add('hidden');
            
            // Update rune displays with level indicators
            Object.keys(runeLevels).forEach(runeId => {
                updateRuneDisplay(runeId);
            });
            
            // Update achievements counts
            updateAchievementCounts();
        });
        
        document.getElementById('settingsTab').addEventListener('click', function() {
            setActiveTab('settingsTab');
            document.getElementById('recordView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('runesView').classList.add('hidden');
            document.getElementById('settingsView').classList.remove('hidden');
        });
        
        function setActiveTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
        
        function setupSleepPhaseCalculation() {
            const phaseInputs = document.querySelectorAll('.sleep-phase-input');
            const totalSleepInput = document.getElementById('totalSleep');
            
            function updateTotalSleep() {
                const awakeTime = parseInt(document.getElementById('awakeTime').value) || 0;
                const remSleep = parseInt(document.getElementById('remSleep').value) || 0;
                const lightSleep = parseInt(document.getElementById('lightSleep').value) || 0;
                const deepSleep = parseInt(document.getElementById('deepSleep').value) || 0;
                
                // Calculate total sleep in minutes (excluding awake time)
                const totalSleepMinutes = remSleep + lightSleep + deepSleep;
                
                // Convert to hours with one decimal place
                const totalSleepHours = Math.round(totalSleepMinutes / 60 * 10) / 10;
                
                // Update the total sleep input
                totalSleepInput.value = totalSleepHours;
            }
            
            // Add event listeners to all phase inputs
            phaseInputs.forEach(input => {
                input.addEventListener('input', updateTotalSleep);
            });
        }

        // Sleep form submission
        document.getElementById('sleepForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get input values
            const date = document.getElementById('sleepDate').value;
            
            // Check if a record for this date already exists
            const existingRecord = sleepRecords.find(record => record.date === date);
            if (existingRecord) {
                document.getElementById('dateDuplicateError').classList.remove('hidden');
                return;
            } else {
                document.getElementById('dateDuplicateError').classList.add('hidden');
            }
            
            const awakeTime = parseInt(document.getElementById('awakeTime').value);
            const remSleep = parseInt(document.getElementById('remSleep').value);
            const lightSleep = parseInt(document.getElementById('lightSleep').value);
            const deepSleep = parseInt(document.getElementById('deepSleep').value);
            const totalSleep = parseFloat(document.getElementById('totalSleep').value);
            
            // Calculate sleep score
            const sleepScore = calculateSleepScore(totalSleep, awakeTime, remSleep, lightSleep, deepSleep);
            
            // Calculate Blood Echoes
            const bloodEchoes = calculateBloodEchoes(sleepScore, totalSleep);
            
            // Calculate Insight
            const insight = calculateInsight(remSleep, totalSleep);
            
            // Store the record
            const newRecord = {
                date: date,
                totalSleep: totalSleep,
                awakeTime: awakeTime,
                remSleep: remSleep,
                lightSleep: lightSleep,
                deepSleep: deepSleep,
                sleepScore: sleepScore,
                bloodEchoes: bloodEchoes,
                insight: insight
            };
            
            // Add to records and accumulate totals
            sleepRecords.push(newRecord);
            totalBloodEchoes += bloodEchoes;
            totalInsight += insight;
            
            // Update the UI
            document.getElementById('sleepScoreValue').textContent = sleepScore;
            document.getElementById('sleepScoreBar').style.width = `${sleepScore}%`;
            document.getElementById('bloodEchoesValue').textContent = bloodEchoes.toLocaleString();
            document.getElementById('insightValue').textContent = insight;
            document.getElementById('totalSleepDisplay').textContent = `${totalSleep} hours`;
            document.getElementById('totalBloodEchoes').textContent = totalBloodEchoes.toLocaleString();
            document.getElementById('totalInsight').textContent = totalInsight;
            
            // Generate sleep analysis text
            document.getElementById('sleepAnalysis').textContent = generateSleepAnalysis(sleepScore, totalSleep, awakeTime, remSleep);
            
            // Show results
            document.getElementById('noResultsContent').classList.add('hidden');
            document.getElementById('resultsContent').classList.remove('hidden');
            
            // Update the chart
            updateSleepPhasesChart(awakeTime, remSleep, lightSleep, deepSleep);
            
            // Check for rank up
            updateHunterRank();
            
            // Check for achievements and runes
            checkAchievements();
            
            // Update boss progress
            updateBossForRecord(newRecord);
            
            // Update seasonal event if necessary
            if (Math.random() < 0.1 && currentSeasonalEvent === null) {
                selectRandomSeasonalEvent();
            }
            
            // Save the data
            saveData();
        });
        
        function initializeDemoData() {
            // Initialize with empty data instead of demo records
            sleepRecords = [];
            totalBloodEchoes = 0;
            totalInsight = 0;
            
            // Initialize rune levels
            Object.keys(runeData).forEach(runeId => {
                runeLevels[runeId] = 1; // All unlocked runes start at level 1
            });
            
            // Generate a random starter boss
            generateRandomBoss();
            
            // Don't set a random seasonal event by default
            currentSeasonalEvent = null;
            updateSeasonalEvent();
            
            // Update achievement counts
            updateAchievementCounts();
        }
        
        function updateAchievementCounts() {
            // Update runes count
            const unlockedRunes = document.querySelectorAll('.rune.unlocked').length;
            document.getElementById('runesUnlockedCount').textContent = `${unlockedRunes}/7`;
            
            // Update chalices count
            const unlockedChalices = document.querySelectorAll('.achievement.unlocked').length;
            document.getElementById('chalicesUnlockedCount').textContent = `${unlockedChalices}/7`;
        }
        
        function generateRandomBoss() {
            // Select a random boss template
            const randomIndex = Math.floor(Math.random() * bossTemplates.length);
            const baseBoss = bossTemplates[randomIndex];
            
            // Decide if we should apply a modifier (50% chance)
            let modifiedBoss = {...baseBoss};
            let appliedModifier = null;
            
            if (Math.random() < 0.5) {
                const modifierIndex = Math.floor(Math.random() * bossModifiers.length);
                const modifier = bossModifiers[modifierIndex];
                modifiedBoss = modifier.applyModifier(modifiedBoss);
                appliedModifier = modifier;
            }
            
            // Set current boss data
            currentBossId = modifiedBoss.id;
            currentBossTarget = modifiedBoss.targetNights;
            currentBossProgress = 0;
            currentBossData = {
                ...modifiedBoss,
                modifier: appliedModifier
            };
            
            // Update UI
            updateBossDisplay();
        }
        
        function updateBossDisplay() {
            if (!currentBossData) return;
            
            // Create description by replacing placeholders
            let description = currentBossData.description;
            
            if (currentBossData.targetHours) {
                description = description.replace('{TARGET_HOURS}', currentBossData.targetHours.toFixed(1));
            }
            
            if (currentBossData.targetMins) {
                description = description.replace('{TARGET_MINS}', Math.round(currentBossData.targetMins));
            }
            
            if (currentBossData.targetScore) {
                description = description.replace('{TARGET_SCORE}', Math.round(currentBossData.targetScore));
            }
            
            description = description.replace('{TARGET_NIGHTS}', currentBossData.targetNights);
            
            // Display boss name with potential modifier
            let bossNameDisplay = currentBossData.name;
            if (currentBossData.modifier) {
                bossNameDisplay = `${currentBossData.name} <span class="boss-modifier">${currentBossData.modifier.name}</span>`;
            }
            
            document.getElementById('bossName').innerHTML = bossNameDisplay;
            document.getElementById('bossDescription').textContent = description;
        }
        
        function selectRandomSeasonalEvent() {
            const randomEvent = seasonalEvents[Math.floor(Math.random() * seasonalEvents.length)];
            currentSeasonalEvent = randomEvent.id;
            updateSeasonalEvent();
        }
        
        function updateSeasonalEvent() {
            if (!currentSeasonalEvent) {
                document.getElementById('seasonalBanner').style.display = 'none';
                return;
            }
            
            const eventData = seasonalEvents.find(event => event.id === currentSeasonalEvent);
            if (!eventData) return;
            
            const bannerEl = document.getElementById('seasonalBanner');
            bannerEl.style.display = 'flex';
            bannerEl.innerHTML = `
                <div class="banner-icon">${eventData.icon}</div>
                <div>
                    <h3 class="font-bold">${eventData.name}</h3>
                    <p class="text-sm">${eventData.description}</p>
                    <p class="text-xs mt-1 italic">Reward: ${eventData.rewardDescription}</p>
                </div>
            `;
        }
        
        function calculateSleepScore(totalSleep, awakeTime, remSleep, lightSleep, deepSleep) {
            // Ideal sleep parameters
            const idealSleepHours = 8;
            const idealDeepSleepPercent = 0.25; // 25% of total sleep
            const idealRemSleepPercent = 0.25; // 25% of total sleep
            const idealLightSleepPercent = 0.5; // 50% of total sleep
            
            // Calculate total sleep time in minutes (excluding awake time)
            const actualSleepMinutes = remSleep + lightSleep + deepSleep;
            
            // Calculate scores for different aspects
            const durationScore = Math.min(100, (totalSleep / idealSleepHours) * 100);
            
            // Phase distribution scores
            const deepSleepPercent = deepSleep / actualSleepMinutes;
            const remSleepPercent = remSleep / actualSleepMinutes;
            const lightSleepPercent = lightSleep / actualSleepMinutes;
            
            const deepSleepScore = 100 - Math.min(100, Math.abs(deepSleepPercent - idealDeepSleepPercent) * 300);
            const remSleepScore = 100 - Math.min(100, Math.abs(remSleepPercent - idealRemSleepPercent) * 300);
            const lightSleepScore = 100 - Math.min(100, Math.abs(lightSleepPercent - idealLightSleepPercent) * 200);
            
            // Awake time penalizes score
            const awakePercent = awakeTime / (actualSleepMinutes + awakeTime);
            const awakeScore = Math.max(0, 100 - (awakePercent * 500)); // Higher penalty for awake time
            
            // Apply effects from runes
            let deepSleepBoost = 1;
            let remSleepBoost = 1;
            
            if (document.getElementById('rune-deep').classList.contains('unlocked')) {
                const runeLevel = runeLevels['rune-deep'] || 1;
                const runeBonus = runeData['rune-deep'].levels[runeLevel - 1].bonus / 100;
                deepSleepBoost = 1 + runeBonus;
            }
            
            if (document.getElementById('rune-clarity').classList.contains('unlocked')) {
                const runeLevel = runeLevels['rune-clarity'] || 1;
                const runeBonus = runeData['rune-clarity'].levels[runeLevel - 1].bonus / 100;
                remSleepBoost = 1 + runeBonus;
            }
            
            // Apply consistency bonus from Anti-Clockwise Rune
            let consistencyBonus = 0;
            if (document.getElementById('rune-anti-clockwise').classList.contains('unlocked')) {
                // Get the bonus based on rune level
                const runeLevel = runeLevels['rune-anti-clockwise'] || 1;
                const baseBonus = runeData['rune-anti-clockwise'].levels[runeLevel - 1].bonus;
                
                // Check recent sleep consistency
                if (sleepRecords.length >= 3) {
                    const recentRecords = [...sleepRecords].slice(-3);
                    const timeVariance = Math.max(...recentRecords.map(r => Math.abs(r.totalSleep - totalSleep)));
                    if (timeVariance < 1) { // Less than 1 hour variance
                        consistencyBonus = baseBonus; // Apply bonus based on rune level
                    }
                }
            }
            
            // Weighted score with rune boosts
            const finalScore = Math.round(
                durationScore * 0.3 +
                (deepSleepScore * deepSleepBoost) * 0.2 +
                (remSleepScore * remSleepBoost) * 0.2 +
                lightSleepScore * 0.1 +
                awakeScore * 0.2 +
                consistencyBonus
            );
            
            return Math.min(100, Math.max(1, finalScore)); // Ensure score is between 1-100
        }
        
        function calculateBloodEchoes(sleepScore, totalSleep) {
            // Base value from sleep score
            let echoes = sleepScore * 100;
            
            // Bonus for sleep duration (especially for sleeping close to 8 hours)
            const durationMultiplier = Math.min(2, Math.max(0.5, 1 + (totalSleep - 6) * 0.25));
            echoes *= durationMultiplier;
            
            // Random fluctuation to make it more game-like
            const randomFactor = 0.9 + (Math.random() * 0.2); // 0.9 to 1.1
            echoes *= randomFactor;
            
            // Apply rune boost if moon rune is unlocked
            if (document.getElementById('rune-moon').classList.contains('unlocked')) {
                const runeLevel = runeLevels['rune-moon'] || 1;
                const bonus = runeData['rune-moon'].levels[runeLevel - 1].bonus / 100;
                echoes *= (1 + bonus);
            }
            
            // Apply weekend bonus if Communion rune is unlocked
            if (document.getElementById('rune-communion').classList.contains('unlocked')) {
                const date = new Date(document.getElementById('sleepDate').value);
                const day = date.getDay();
                if (day === 0 || day === 6) { // Weekend (0 = Sunday, 6 = Saturday)
                    const runeLevel = runeLevels['rune-communion'] || 1;
                    const bonus = runeData['rune-communion'].levels[runeLevel - 1].bonus / 100;
                    echoes *= (1 + bonus);
                }
            }
            
            return Math.round(echoes);
        }
        
        function calculateInsight(remSleep, totalSleep) {
            // Insight is primarily based on REM sleep (where dreams occur)
            const baseInsight = (remSleep / 60) * 3; // About 3 insight per REM hour
            
            // Bonus for longer sleep with good REM ratio
            const remRatio = remSleep / (totalSleep * 60);
            let bonusInsight = 0;
            
            if (remRatio >= 0.2 && remRatio <= 0.3 && totalSleep >= 7) {
                bonusInsight = 5; // Good REM sleep ratio and length
            }
            
            // Random element for gameplay
            const randomInsight = Math.floor(Math.random() * 3); // 0 to 2 random insight
            
            // Apply rune boost if Great Lake rune is unlocked
            let insightTotal = Math.round(baseInsight + bonusInsight + randomInsight);
            
            if (document.getElementById('rune-great-lake').classList.contains('unlocked')) {
                const runeLevel = runeLevels['rune-great-lake'] || 1;
                const bonus = runeData['rune-great-lake'].levels[runeLevel - 1].bonus / 100;
                insightTotal = Math.round(insightTotal * (1 + bonus));
            }
            
            return insightTotal;
        }
        
        function generateSleepAnalysis(sleepScore, totalSleep, awakeTime, remSleep) {
            let analysis = "";
            
            if (sleepScore >= 90) {
                analysis = "The Hunter found rare tranquility in the dream. The Old Blood flows strong within.";
            } else if (sleepScore >= 75) {
                analysis = "A restful slumber worthy of the Hunter's Workshop. The nightmare kept at bay.";
            } else if (sleepScore >= 60) {
                analysis = "The Hunter's rest was adequate, though the echoes of beasts remained distant.";
            } else if (sleepScore >= 40) {
                analysis = "Restless dreams plague the Hunter. The Healing Church would recommend more peaceful slumber.";
            } else {
                analysis = "The nightmare follows the Hunter even in waking. May you find peace in the waking world.";
            }
            
            // Add commentary based on specific metrics
            if (awakeTime > 60) {
                analysis += " Many interruptions disturbed your hunt for rest.";
            }
            
            if (remSleep > (totalSleep * 60 * 0.3)) {
                analysis += " The dream was particularly vivid, granting greater insight.";
            } else if (remSleep < (totalSleep * 60 * 0.15)) {
                analysis += " Few dreams were remembered; the Great Ones remain silent.";
            }
            
            // Add commentary for consistency if Anti-Clockwise Rune is unlocked
            if (document.getElementById('rune-anti-clockwise').classList.contains('unlocked') && sleepRecords.length >= 3) {
                const recentRecords = [...sleepRecords].slice(-3);
                const timeVariance = Math.max(...recentRecords.map(r => Math.abs(r.totalSleep - totalSleep)));
                if (timeVariance < 1) {
                    analysis += " Your consistent rhythm of sleep pleases the cosmos.";
                }
            }
            
            return analysis;
        }
        
        function updateSleepPhasesChart(awakeTime, remSleep, lightSleep, deepSleep) {
            const ctx = document.getElementById('sleepPhasesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (sleepPhasesChart) {
                sleepPhasesChart.destroy();
            }
            
            const borderColor = document.body.classList.contains('dark') ? '#ffffff' : '#333333';
            
            sleepPhasesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Awake', 'REM Sleep', 'Light Sleep', 'Deep Sleep'],
                    datasets: [{
                        data: [awakeTime, remSleep, lightSleep, deepSleep],
                        backgroundColor: [
                            '#e98a17', // Awake - orange
                            '#8a0303', // REM - dark red
                            '#b30404', // Light - medium red 
                            '#3f0101'  // Deep - very dark red
                        ],
                        borderColor: Array(4).fill(borderColor),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                font: {
                                    family: 'EB Garamond'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label;
                                    const value = context.raw;
                                    const hours = Math.floor(value / 60);
                                    const minutes = value % 60;
                                    return `${label}: ${hours}h ${minutes}m`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function initializeHistoryCharts() {
            const weeklyScoreCtx = document.getElementById('weeklyScoreChart').getContext('2d');
            const sleepConsistencyCtx = document.getElementById('sleepConsistencyChart').getContext('2d');
            
            // Destroy existing charts if they exist
            if (weeklyScoreChart) weeklyScoreChart.destroy();
            if (sleepConsistencyChart) sleepConsistencyChart.destroy();
            
            // Sort records by date for proper visualization
            sleepRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Get last 14 days of records for charts or all if less than 14
            const recentRecords = sleepRecords.slice(-14);
            
            if (recentRecords.length === 0) {
                // If no records, create empty charts with placeholder data
                weeklyScoreChart = new Chart(weeklyScoreCtx, {
                    type: 'line',
                    data: {
                        labels: ['No data available'],
                        datasets: [
                            {
                                label: 'Sleep Score',
                                data: [],
                                borderColor: '#a5181d',
                                backgroundColor: 'rgba(165, 24, 29, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Blood Echoes (100)',
                                data: [],
                                borderColor: '#6e1212',
                                backgroundColor: 'rgba(110, 18, 18, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.3,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                    font: {
                                        family: 'EB Garamond'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                grid: {
                                    color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                grid: {
                                    color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
                
                sleepConsistencyChart = new Chart(sleepConsistencyCtx, {
                    type: 'line',
                    data: {
                        labels: ['No data available'],
                        datasets: [
                            {
                                label: 'Sleep Duration (hours)',
                                data: [],
                                borderColor: '#a5181d',
                                backgroundColor: 'rgba(165, 24, 29, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Bedtime (hour)',
                                data: [],
                                borderColor: '#e98a17',
                                backgroundColor: 'rgba(233, 138, 23, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.3,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                    font: {
                                        family: 'EB Garamond'
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Sleep Duration (hours)',
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                beginAtZero: true,
                                max: 12,
                                ticks: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                grid: {
                                    color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Bedtime (hour)',
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                min: 21, // 9 PM
                                max: 25, // 1 AM (25 for easier visualization)
                                ticks: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                                },
                                grid: {
                                    color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
                
                return;
            }
            
            // Prepare data for weekly scores
            const dates = recentRecords.map(record => formatDate(record.date));
            const scores = recentRecords.map(record => record.sleepScore);
            const bloodEchoes = recentRecords.map(record => record.bloodEchoes / 100); // Scaled down to fit on chart
            
            weeklyScoreChart = new Chart(weeklyScoreCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Sleep Score',
                            data: scores,
                            borderColor: '#a5181d',
                            backgroundColor: 'rgba(165, 24, 29, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Blood Echoes (100)',
                            data: bloodEchoes,
                            borderColor: '#6e1212',
                            backgroundColor: 'rgba(110, 18, 18, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                font: {
                                    family: 'EB Garamond'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.raw;
                                    if (label === 'Blood Echoes (100)') {
                                        return `Blood Echoes: ${(value * 100).toLocaleString()}`;
                                    }
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                            },
                            grid: {
                                color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Prepare data for sleep consistency (sleep duration and bedtime consistency)
            const sleepDurations = recentRecords.map(record => record.totalSleep);
            
            // Generate estimated bedtime data based on wake time patterns
            // This is an estimation since we don't actually collect bedtime
            const bedtimes = recentRecords.map((record, index) => {
                if (index === 0) {
                    return 23; // Default 11 PM for first entry
                }
                
                // Use some variance based on sleep duration pattern
                const prevDuration = recentRecords[index-1].totalSleep;
                const currDuration = record.totalSleep;
                const durationDiff = currDuration - prevDuration;
                
                // If sleep duration increased, assume earlier bedtime
                // If decreased, assume later bedtime
                return 23 - (durationDiff * 0.3);
            });
            
            sleepConsistencyChart = new Chart(sleepConsistencyCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Sleep Duration (hours)',
                            data: sleepDurations,
                            borderColor: '#a5181d',
                            backgroundColor: 'rgba(165, 24, 29, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Bedtime (hour)',
                            data: bedtimes,
                            borderColor: '#e98a17',
                            backgroundColor: 'rgba(233, 138, 23, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                font: {
                                    family: 'EB Garamond'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.raw;
                                    if (label === 'Bedtime (hour)') {
                                        // Convert 24-hour to 12-hour format
                                        const hour = Math.floor(value);
                                        const minute = Math.round((value - hour) * 60);
                                        const period = hour >= 12 ? 'PM' : 'AM';
                                        const hour12 = hour % 12 || 12;
                                        return `Bedtime: ${hour12}:${minute.toString().padStart(2, '0')} ${period}`;
                                    }
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Sleep Duration (hours)',
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                            },
                            beginAtZero: true,
                            max: 12,
                            ticks: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                            },
                            grid: {
                                color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Bedtime (hour)',
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d'
                            },
                            min: 21, // 9 PM
                            max: 25, // 1 AM (25 for easier visualization)
                            ticks: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                callback: function(value) {
                                    // Convert 24-hour to 12-hour format for display
                                    if (value === 21) return '9 PM';
                                    if (value === 22) return '10 PM';
                                    if (value === 23) return '11 PM';
                                    if (value === 24) return '12 AM';
                                    if (value === 25) return '1 AM';
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: document.body.classList.contains('dark') ? '#d3cfc7' : '#2d2d2d',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString(undefined, { 
                month: 'short', 
                day: 'numeric'
            });
        }
        
        function populateHistoryTable() {
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            
            if (sleepRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="py-4 px-4 text-center text-gray-500">No sleep records yet. Start tracking your sleep to see your history.</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // Get the most recent 7 records
            const recentRecords = [...sleepRecords].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 7);
            
            recentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700';
                
                // Format the date
                const dateObj = new Date(record.date);
                const formattedDate = dateObj.toLocaleDateString(undefined, { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                row.innerHTML = `
                    <td class="py-2 px-4">${formattedDate}</td>
                    <td class="py-2 px-4">${record.sleepScore}</td>
                    <td class="py-2 px-4">${record.totalSleep.toFixed(1)}</td>
                    <td class="py-2 px-4">${record.bloodEchoes.toLocaleString()}</td>
                    <td class="py-2 px-4">${record.insight}</td>
                    <td class="py-2 px-4">
                        <button class="text-red-500 hover:text-red-700 delete-record-btn" data-date="${record.date}">
                            Delete
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const date = this.getAttribute('data-date');
                    showDeleteRecordModal(date);
                });
            });
        }
        
        function showDeleteRecordModal(date) {
            const record = sleepRecords.find(r => r.date === date);
            if (!record) return;
            
            // Format the date for display
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString(undefined, { 
                weekday: 'long', 
                year: 'numeric',
                month: 'long', 
                day: 'numeric' 
            });
            
            // Set details in the modal
            document.getElementById('deleteRecordDetails').textContent = `Date: ${formattedDate}`;
            
            // Set the date attribute on the confirm button for use in the delete function
            document.getElementById('confirmDeleteBtn').setAttribute('data-date', date);
            
            // Show the modal
            document.getElementById('deleteRecordModal').classList.add('active');
        }
        
        function deleteRecord(date) {
            // Find the record to delete
            const recordIndex = sleepRecords.findIndex(r => r.date === date);
            if (recordIndex === -1) return;
            
            const record = sleepRecords[recordIndex];
            
            // Deduct the blood echoes and insight from totals
            totalBloodEchoes -= record.bloodEchoes;
            totalInsight -= record.insight;
            
            // Remove the record
            sleepRecords.splice(recordIndex, 1);
            
            // Update UI elements that might be affected
            document.getElementById('totalBloodEchoes').textContent = totalBloodEchoes.toLocaleString();
            document.getElementById('totalInsight').textContent = totalInsight;
            
            // Re-update hunter rank in case it changed
            updateHunterRank();
            
            // Update history tables and charts
            populateHistoryTable();
            initializeHistoryCharts();
            
            // Save the updated data
            saveData();
            
            // Show notification
            showNotification("Record Deleted", "The sleep record has been deleted successfully.");
        }
        
        function updateHunterRank() {
            // Define rank thresholds
            const rankThresholds = [
                0,          // Waking Hunter I
                100000,     // Dream Hunter II
                250000,     // Nightmare Hunter III
                500000,     // Blood-Drunk Hunter IV
                1000000,    // Great One V
                2000000     // Elder Great One VI
            ];
            
            const rankNames = [
                "Waking Hunter I",
                "Dream Hunter II",
                "Nightmare Hunter III",
                "Blood-Drunk Hunter IV",
                "Great One V",
                "Elder Great One VI"
            ];
            
            // Determine current rank
            let newRank = 0;
            for (let i = 0; i < rankThresholds.length; i++) {
                if (totalBloodEchoes >= rankThresholds[i]) {
                    newRank = i;
                } else {
                    break;
                }
            }
            
            // Update UI if rank changed
            if (newRank !== currentHunterRank) {
                if (newRank > currentHunterRank) {
                    // Rank up!
                    showNotification("Rank Up!", `You've ascended to ${rankNames[newRank]}!`);
                }
                currentHunterRank = newRank;
                document.getElementById('hunterRank').textContent = rankNames[newRank];
                
                // Update runes & chalices UI too
                document.getElementById('currentRank').textContent = rankNames[newRank];
                if (newRank < rankThresholds.length - 1) {
                    document.getElementById('nextRank').textContent = rankNames[newRank + 1];
                } else {
                    document.getElementById('nextRank').textContent = "Max Rank";
                }
            }
            
            // Update rank progress bar
            if (newRank < rankThresholds.length - 1) {
                const currentThreshold = rankThresholds[newRank];
                const nextThreshold = rankThresholds[newRank + 1];
                const progress = ((totalBloodEchoes - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
                
                document.getElementById('rankProgressBar').style.width = `${progress}%`;
                document.getElementById('rankProgressText').textContent = 
                    `${totalBloodEchoes.toLocaleString()} / ${nextThreshold.toLocaleString()} Blood Echoes`;
                
                // Update rank circles
                document.querySelectorAll('.progress-circle').forEach((circle, index) => {
                    if (index < newRank) {
                        // Completed ranks
                        circle.style.background = `conic-gradient(var(--primary-color) 100%, #2c2c2c 0%)`;
                    } else if (index === newRank) {
                        // Current rank - show progress
                        circle.style.background = `conic-gradient(var(--primary-color) ${progress}%, #2c2c2c 0%)`;
                    } else {
                        // Future ranks
                        circle.style.background = `conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)`;
                    }
                });
            } else if (newRank === rankThresholds.length - 1) {
                // Max rank reached
                document.getElementById('rankProgressBar').style.width = `100%`;
                document.getElementById('rankProgressText').textContent = 
                    `${totalBloodEchoes.toLocaleString()} Blood Echoes (Max Rank)`;
                
                // All rank circles filled
                document.querySelectorAll('.progress-circle').forEach(circle => {
                    circle.style.background = `conic-gradient(var(--primary-color) 100%, #2c2c2c 0%)`;
                });
            }
        }
        
        function checkAchievements() {
            // Unlock runes based on achievements
            
            // Example: Unlock Moon Rune after collecting 50,000 Blood Echoes
            if (totalBloodEchoes >= 50000) {
                const moonRune = document.getElementById('rune-moon');
                if (!moonRune.classList.contains('unlocked')) {
                    moonRune.classList.add('unlocked');
                    // Add level indicator too
                    runeLevels['rune-moon'] = 1;
                    updateRuneDisplay('rune-moon');
                    // Alert about unlocking only the first time
                    showNotification("Rune Unlocked!", "You've found the Moon Rune - +10% Blood Echoes from all future sleeps.");
                }
            }
            
            // Example: Unlock Great Lake Rune after collecting 25 Insight
            if (totalInsight >= 25) {
                const lakeRune = document.getElementById('rune-great-lake');
                if (!lakeRune.classList.contains('unlocked')) {
                    lakeRune.classList.add('unlocked');
                    runeLevels['rune-great-lake'] = 1;
                    updateRuneDisplay('rune-great-lake');
                    showNotification("Rune Unlocked!", "You've found the Great Lake Rune - +20% Insight from REM sleep.");
                }
            }
            
            // Unlock Communion Rune after 10 recorded sleeps
            if (sleepRecords.length >= 10) {
                const communionRune = document.getElementById('rune-communion');
                if (!communionRune.classList.contains('unlocked')) {
                    communionRune.classList.add('unlocked');
                    runeLevels['rune-communion'] = 1;
                    updateRuneDisplay('rune-communion');
                    showNotification("Rune Unlocked!", "You've found the Communion Rune - +30% Blood Echoes on weekends.");
                }
            }
            
            // Unlock runes based on recent sleep records
            const recentRecords = [...sleepRecords].slice(-5); // Last 5 records
            
            // Check if there are at least 3 consecutive nights with a score of 85+
            if (recentRecords.length >= 3) {
                let consecutiveHighScores = 0;
                for (let i = recentRecords.length - 1; i >= 0; i--) {
                    if (recentRecords[i].sleepScore >= 85) {
                        consecutiveHighScores++;
                        if (consecutiveHighScores >= 3) {
                            // Unlock first chalice
                            const chalice1 = document.getElementById('chalice-1');
                            if (!chalice1.classList.contains('unlocked')) {
                                chalice1.classList.add('unlocked');
                                showNotification("Chalice Unlocked!", "You've discovered the Pthumeru Chalice!");
                                updateAchievementCounts();
                            }
                            break;
                        }
                    } else {
                        consecutiveHighScores = 0;
                    }
                }
            }
            
            // Check for deep sleep achievements
            if (recentRecords.length >= 5) {
                let deepSleepNights = 0;
                for (let i = recentRecords.length - 1; i >= 0; i--) {
                    if (recentRecords[i].deepSleep >= 90) { // 90+ minutes of deep sleep
                        deepSleepNights++;
                        if (deepSleepNights >= 3) {
                            // Unlock Deep Sleep rune
                            const deepRune = document.getElementById('rune-deep');
                            if (!deepRune.classList.contains('unlocked')) {
                                deepRune.classList.add('unlocked');
                                runeLevels['rune-deep'] = 1;
                                updateRuneDisplay('rune-deep');
                                showNotification("Rune Unlocked!", "You've found the Deep Sleep Rune - +15% efficiency from Deep Sleep.");
                                updateAchievementCounts();
                            }
                            break;
                        }
                    }
                }
            }
            
            // Check for any 100 score achievement
            const perfectScoreRecord = sleepRecords.find(record => record.sleepScore >= 100);
            if (perfectScoreRecord) {
                const hintertombChalice = document.getElementById('chalice-7');
                if (!hintertombChalice.classList.contains('unlocked')) {
                    hintertombChalice.classList.add('unlocked');
                    showNotification("Chalice Unlocked!", "You've discovered the Hintertomb Chalice!");
                    updateAchievementCounts();
                }
            }
        }
        
        function updateBossForRecord(record) {
            // If no current boss, generate one
            if (!currentBossData) {
                generateRandomBoss();
                return;
            }
            
            // Get previous record for comparison if needed
            const prevRecord = sleepRecords.length > 1 ? sleepRecords[sleepRecords.length - 2] : null;
            
            // Check if the record meets the boss condition
            let conditionMet = false;
            
            // Handle different types of boss check conditions based on parameters
            if (currentBossData.checkCondition) {
                if (currentBossData.targetMins && currentBossData.targetScore) {
                    // For bosses that need both score and minutes (like Amygdala)
                    conditionMet = currentBossData.checkCondition(record, {
                        mins: currentBossData.targetMins,
                        score: currentBossData.targetScore
                    });
                } else if (currentBossData.targetHours) {
                    // For hour-based checks
                    conditionMet = currentBossData.checkCondition(record, currentBossData.targetHours);
                } else if (currentBossData.targetMins) {
                    // For minute-based checks
                    conditionMet = currentBossData.checkCondition(record, currentBossData.targetMins, prevRecord);
                } else if (currentBossData.targetScore) {
                    // For score-based checks
                    conditionMet = currentBossData.checkCondition(record, currentBossData.targetScore);
                } else {
                    // For custom checks that don't need parameters
                    conditionMet = currentBossData.checkCondition(record, null, prevRecord);
                }
            }
            
            if (conditionMet) {
                if (currentBossProgress < currentBossTarget) {
                    currentBossProgress++;
                    showNotification("Boss Progress", `${currentBossData.name} hunt progress: ${currentBossProgress}/${currentBossTarget}`);
                }
            } else if (!currentBossData.noReset) {
                // Reset progress on failed night (unless boss has noReset flag)
                currentBossProgress = 0;
            }
            
            // Update UI
            updateBossProgress();
            
            // Check if boss is defeated
            if (currentBossProgress >= currentBossTarget) {
                bossBattleCompleted();
            }
        }
        
        function updateBossProgress() {
            if (!currentBossData) return;
            
            document.getElementById('bossProgress').textContent = `${currentBossProgress}/${currentBossTarget} nights`;
            const progressPercent = (currentBossProgress / currentBossTarget) * 100;
            document.getElementById('bossProgressBar').style.width = `${progressPercent}%`;
        }
        
        function bossBattleCompleted() {
            // Add boss to defeated list if not already there
            const bossKey = currentBossData.modifier ? 
                `${currentBossId}_${currentBossData.modifier.id}` : currentBossId;
                
            if (!bossesDefeated.includes(bossKey)) {
                bossesDefeated.push(bossKey);
            }
            
            // Handle rewards based on the defeated boss
            let bloodEchoesReward = currentBossData.baseEchoesReward || 5000;
            let insightReward = 0;
            
            // Apply insight multiplier if present
            if (currentBossData.insightMultiplier) {
                insightReward = Math.round(10 * currentBossData.insightMultiplier);
            } else {
                // Default insight reward
                insightReward = 5;
            }
            
            // Award blood echoes and insight
            totalBloodEchoes += bloodEchoesReward;
            totalInsight += insightReward;
            
            document.getElementById('totalBloodEchoes').textContent = totalBloodEchoes.toLocaleString();
            document.getElementById('totalInsight').textContent = totalInsight;
            
            // Unlock rune if applicable
            if (currentBossData.runeReward) {
                const runeElement = document.getElementById(currentBossData.runeReward);
                if (runeElement && !runeElement.classList.contains('unlocked')) {
                    runeElement.classList.add('unlocked');
                    runeLevels[currentBossData.runeReward] = 1;
                    updateRuneDisplay(currentBossData.runeReward);
                    const runeName = runeData[currentBossData.runeReward]?.title || "New Rune";
                    showNotification("Rune Unlocked!", `You've found the ${runeName}!`);
                    updateAchievementCounts();
                }
            }
            
            // Format the boss name for display
            let bossName = currentBossData.name;
            if (currentBossData.modifier) {
                bossName = `${bossName} (${currentBossData.modifier.name})`;
            }
            
            // Show notification
            showNotification("Boss Defeated!", `You've defeated ${bossName}! Earned ${bloodEchoesReward.toLocaleString()} Blood Echoes and ${insightReward} Insight.`);
            
            // Queue next boss
            generateRandomBoss();
            
            // Update boss trophies
            updateBossTrophies();
            
            // Save data
            saveData();
        }
        
        function updateBossTrophies() {
            const trophyContainer = document.getElementById('bossTrophyContainer');
            trophyContainer.innerHTML = '';
            
            if (bossesDefeated.length === 0) return;
            
            // Create trophy for each defeated boss
            bossesDefeated.forEach(bossKey => {
                const trophy = document.createElement('div');
                trophy.className = 'trophy';
                
                // Parse boss ID and possible modifier ID
                let bossId = bossKey;
                let modifierId = null;
                
                if (bossKey.includes('_')) {
                    [bossId, modifierId] = bossKey.split('_');
                }
                
                // Find boss template
                const bossTemplate = bossTemplates.find(b => b.id === bossId);
                if (!bossTemplate) return;
                
                // Get boss name
                let bossName = bossTemplate.name;
                
                // Add modifier name if present
                if (modifierId) {
                    const modifier = bossModifiers.find(m => m.id === modifierId);
                    if (modifier) {
                        trophy.title = `${bossName} (${modifier.name})`;
                        // Either display with modifier or just initial for space reasons
                        bossName = `${bossName.split(',')[0]} (${modifier.name.charAt(0)})`;
                    }
                } else {
                    trophy.title = bossName;
                    // Just use first name for space
                    bossName = bossName.split(',')[0];
                }
                
                trophy.textContent = bossName;
                trophyContainer.appendChild(trophy);
            });
        }
        
        function showNotification(title, message) {
            // Check if notifications are enabled
            if (!document.getElementById('showNotifications').checked) return;
            
            // Set notification content
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            // Show notification
            const notification = document.getElementById('notification');
            notification.classList.add('show');
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        function showNewBossModal() {
            if (!currentBossData) return;
            
            // Format the boss name
            let bossName = currentBossData.name;
            if (currentBossData.modifier) {
                bossName = `${bossName} <span class="boss-modifier">${currentBossData.modifier.name}</span>`;
            }
            
            // Create boss description by replacing placeholders
            let description = currentBossData.description;
            
            if (currentBossData.targetHours) {
                description = description.replace('{TARGET_HOURS}', currentBossData.targetHours.toFixed(1));
            }
            
            if (currentBossData.targetMins) {
                description = description.replace('{TARGET_MINS}', Math.round(currentBossData.targetMins));
            }
            
            if (currentBossData.targetScore) {
                description = description.replace('{TARGET_SCORE}', Math.round(currentBossData.targetScore));
            }
            
            description = description.replace('{TARGET_NIGHTS}', currentBossData.targetNights);
            
            // Set the boss details in the modal
            document.getElementById('newBossName').innerHTML = bossName;
            document.getElementById('newBossDescription').textContent = description;
            
            // Set rewards based on boss
            const bloodEchoesReward = currentBossData.baseEchoesReward || 5000;
            let runeReward = "Insight Points";
            
            if (currentBossData.runeReward && runeData[currentBossData.runeReward]) {
                runeReward = `${runeData[currentBossData.runeReward].title} - ${runeData[currentBossData.runeReward].levels[0].description}`;
            }
            
            document.getElementById('newBossReward1').textContent = `${bloodEchoesReward.toLocaleString()} Blood Echoes`;
            document.getElementById('newBossReward2').textContent = runeReward;
            
            // Show the modal
            document.getElementById('newBossModal').classList.add('active');
        }
        
        // Rune system functions
        function updateRuneDisplay(runeId) {
            const runeElement = document.getElementById(runeId);
            if (!runeElement || !runeElement.classList.contains('unlocked')) return;
            
            const level = runeLevels[runeId] || 1;
            
            // Find or create the level indicator
            let levelIndicator = runeElement.querySelector('.rune-level');
            if (!levelIndicator) {
                levelIndicator = document.createElement('span');
                levelIndicator.className = 'rune-level absolute bottom-0 right-0 bg-red-900 rounded-full w-4 h-4 flex items-center justify-center text-xs text-white font-bold';
                runeElement.style.position = 'relative';
                runeElement.appendChild(levelIndicator);
            }
            
            // Set level indicator text (I, II, III)
            const romanNumerals = ['I', 'II', 'III', 'IV', 'V'];
            levelIndicator.textContent = romanNumerals[level - 1] || level;
        }
        
        // Rune tooltips and upgrade UI
        const runes = document.querySelectorAll('.rune');
        runes.forEach(rune => {
            rune.addEventListener('click', function() {
                const runeId = this.id;
                const runeDescription = document.getElementById('runeDescription');
                
                if (!runeData[runeId]) {
                    runeDescription.innerHTML = `
                        <h4 class="font-bold">Unknown Rune (Locked)</h4>
                        <p class="text-gray-400 mt-2">This rune's meaning is yet to be discovered.</p>
                        <p class="text-sm mt-2 italic">Continue your hunt for good sleep.</p>
                    `;
                    return;
                }
                
                const rune = runeData[runeId];
                const unlocked = this.classList.contains('unlocked');
                
                if (!unlocked) {
                    runeDescription.innerHTML = `
                        <h4 class="font-bold">${rune.title} (Locked)</h4>
                        <p class="text-gray-400 mt-2">${rune.levels[0].description}</p>
                        <p class="text-sm mt-2 italic">${rune.unlockCondition}</p>
                    `;
                    return;
                }
                
                // For unlocked runes, show current level and upgrade options
                const currentLevel = runeLevels[runeId] || 1;
                const currentLevelData = rune.levels[currentLevel - 1];
                let upgradeButton = '';
                
                if (currentLevel < rune.levels.length) {
                    const nextLevelData = rune.levels[currentLevel];
                    upgradeButton = `
                        <div class="mt-4">
                            <h5 class="font-bold">Upgrade to Level ${currentLevel + 1}</h5>
                            <p class="text-sm">${nextLevelData.description}</p>
                            <p class="text-sm my-2">Cost: <span class="font-bold">${nextLevelData.cost}</span> Insight</p>
                            <button class="upgrade-rune-btn blood-btn py-1 px-3 text-white rounded text-sm" 
                                    data-rune-id="${runeId}" 
                                    data-level="${currentLevel + 1}" 
                                    data-cost="${nextLevelData.cost}"
                                    ${totalInsight >= nextLevelData.cost ? '' : 'disabled'}>
                                ${totalInsight >= nextLevelData.cost ? 'Upgrade' : 'Not Enough Insight'}
                            </button>
                        </div>
                    `;
                }
                
                // Add Roman numeral for the level
                const romanNumerals = ['I', 'II', 'III', 'IV', 'V'];
                const levelRoman = romanNumerals[currentLevel - 1] || currentLevel;
                
                runeDescription.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold">${rune.title} ${levelRoman}</h4>
                        <span class="bg-red-900 text-white text-xs px-2 py-1 rounded">Level ${currentLevel}</span>
                    </div>
                    <p class="text-gray-400 mt-2">${currentLevelData.description}</p>
                    ${upgradeButton}
                `;
                
                // Add event listener for upgrade button
                const upgradeBtn = runeDescription.querySelector('.upgrade-rune-btn');
                if (upgradeBtn) {
                    upgradeBtn.addEventListener('click', function() {
                        const targetRune = this.dataset.runeId;
                        const targetLevel = parseInt(this.dataset.level);
                        const cost = parseInt(this.dataset.cost);
                        
                        if (totalInsight >= cost) {
                            // Deduct insight
                            totalInsight -= cost;
                            document.getElementById('totalInsight').textContent = totalInsight;
                            
                            // Upgrade rune
                            runeLevels[targetRune] = targetLevel;
                            
                            // Show notification
                            showNotification(`Rune Upgraded!`, `${runeData[targetRune].title} is now level ${targetLevel}!`);
                            
                            // Update rune display
                            updateRuneDisplay(targetRune);
                            
                            // Update the description to show new level
                            const rune = document.getElementById(targetRune);
                            rune.click(); // Re-click to refresh description
                            
                            // Save data
                            saveData();
                        }
                    });
                }
            });
        });
        
        // Auto-save functionality
        function startAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            
            autoSaveTimer = setInterval(() => {
                const saved = saveData();
                if (saved) {
                    // Show auto-save indicator
                    const indicator = document.getElementById('autosaveIndicator');
                    indicator.classList.add('show');
                    
                    // Hide after 2 seconds
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }
            }, 30000); // Save every 30 seconds
        }
        
        // Save and load data functions
        function saveData() {
            const gameData = {
                sleepRecords: sleepRecords,
                totalBloodEchoes: totalBloodEchoes,
                totalInsight: totalInsight,
                currentHunterRank: currentHunterRank,
                bossesDefeated: bossesDefeated,
                currentBossId: currentBossId,
                currentBossData: currentBossData,
                currentBossProgress: currentBossProgress,
                currentBossTarget: currentBossTarget,
                currentSeasonalEvent: currentSeasonalEvent,
                runeLevels: runeLevels,
                unlockedRunes: Array.from(document.querySelectorAll('.rune.unlocked')).map(rune => rune.id),
                unlockedChalices: Array.from(document.querySelectorAll('.achievement.unlocked')).map(chalice => chalice.id),
                lastSaved: new Date().toISOString(),
                version: "1.4.0"
            };
            
            try {
                localStorage.setItem('huntersDreamData', JSON.stringify(gameData));
                return true;
            } catch (error) {
                console.error("Failed to save data:", error);
                return false;
            }
        }
        
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('huntersDreamData');
                
                if (savedData) {
                    const gameData = JSON.parse(savedData);
                    
                    // Load basic data
                    sleepRecords = gameData.sleepRecords || [];
                    totalBloodEchoes = gameData.totalBloodEchoes || 0;
                    totalInsight = gameData.totalInsight || 0;
                    currentHunterRank = gameData.currentHunterRank || 0;
                    bossesDefeated = gameData.bossesDefeated || [];
                    currentSeasonalEvent = gameData.currentSeasonalEvent || null;
                    
                    // Load rune levels
                    runeLevels = gameData.runeLevels || {};
                    
                    // Ensure all unlocked runes have a level
                    if (gameData.unlockedRunes) {
                        gameData.unlockedRunes.forEach(runeId => {
                            if (!runeLevels[runeId]) {
                                runeLevels[runeId] = 1;
                            }
                        });
                    }
                    
                    // Load boss data
                    if (gameData.currentBossData) {
                        currentBossData = gameData.currentBossData;
                        currentBossProgress = gameData.currentBossProgress || 0;
                        currentBossTarget = gameData.currentBossTarget || 5;
                        currentBossId = gameData.currentBossId;
                        
                        // Update boss display
                        updateBossDisplay();
                    } else {
                        // Generate new boss if no saved boss data
                        generateRandomBoss();
                    }
                    
                    // Restore unlocked runes
                    if (gameData.unlockedRunes && Array.isArray(gameData.unlockedRunes)) {
                        gameData.unlockedRunes.forEach(runeId => {
                            const rune = document.getElementById(runeId);
                            if (rune) {
                                rune.classList.add('unlocked');
                                updateRuneDisplay(runeId);
                            }
                        });
                    }
                    
                    // Restore unlocked chalices
                    if (gameData.unlockedChalices && Array.isArray(gameData.unlockedChalices)) {
                        gameData.unlockedChalices.forEach(chaliceId => {
                            const chalice = document.getElementById(chaliceId);
                            if (chalice) {
                                chalice.classList.add('unlocked');
                            }
                        });
                    }
                    
                    // Update seasonal event banner
                    updateSeasonalEvent();
                    
                    // Update achievement counts
                    updateAchievementCounts();
                    
                    return true;
                } else {
                    // No saved data, initialize with empty data
                    initializeDemoData();
                    return false;
                }
            } catch (error) {
                console.error("Failed to load data:", error);
                // Fall back to empty data
                initializeDemoData();
                return false;
            }
        }
        
        function processImportedData(jsonData) {
            try {
                const gameData = JSON.parse(jsonData);
                
                // Validate the imported data
                if (!gameData.sleepRecords || !Array.isArray(gameData.sleepRecords)) {
                    throw new Error("Invalid data format");
                }
                
                // Reset current data
                resetAllData();
                
                // Import data
                sleepRecords = gameData.sleepRecords || [];
                totalBloodEchoes = gameData.totalBloodEchoes || 0;
                totalInsight = gameData.totalInsight || 0;
                currentHunterRank = gameData.currentHunterRank || 0;
                bossesDefeated = gameData.bossesDefeated || [];
                currentBossData = gameData.currentBossData;
                currentBossProgress = gameData.currentBossProgress || 0;
                currentBossTarget = gameData.currentBossTarget || 5;
                currentBossId = gameData.currentBossId;
                currentSeasonalEvent = gameData.currentSeasonalEvent || null;
                
                // Import rune levels
                runeLevels = gameData.runeLevels || {};
                
                // Restore unlocked runes
                if (gameData.unlockedRunes && Array.isArray(gameData.unlockedRunes)) {
                    gameData.unlockedRunes.forEach(runeId => {
                        const rune = document.getElementById(runeId);
                        if (rune) {
                            rune.classList.add('unlocked');
                            updateRuneDisplay(runeId);
                        }
                    });
                }
                
                // Restore unlocked chalices
                if (gameData.unlockedChalices && Array.isArray(gameData.unlockedChalices)) {
                    gameData.unlockedChalices.forEach(chaliceId => {
                        const chalice = document.getElementById(chaliceId);
                        if (chalice) {
                            chalice.classList.add('unlocked');
                        }
                    });
                }
                
                // Update boss display if we have a current boss
                if (currentBossData) {
                    updateBossDisplay();
                } else {
                    // Generate a new boss if we don't have one
                    generateRandomBoss();
                }
                
                // Update UI
                updateHunterRank();
                updateBossProgress();
                updateSeasonalEvent();
                updateBossTrophies();
                updateAchievementCounts();
                
                // If we have records, show the results
                if (sleepRecords.length > 0) {
                    const latestRecord = sleepRecords[sleepRecords.length - 1];
                    document.getElementById('sleepScoreValue').textContent = latestRecord.sleepScore;
                    document.getElementById('sleepScoreBar').style.width = `${latestRecord.sleepScore}%`;
                    document.getElementById('bloodEchoesValue').textContent = latestRecord.bloodEchoes.toLocaleString();
                    document.getElementById('insightValue').textContent = latestRecord.insight;
                    document.getElementById('totalSleepDisplay').textContent = `${latestRecord.totalSleep} hours`;
                    document.getElementById('totalBloodEchoes').textContent = totalBloodEchoes.toLocaleString();
                    document.getElementById('totalInsight').textContent = totalInsight;
                    document.getElementById('sleepAnalysis').textContent = generateSleepAnalysis(
                        latestRecord.sleepScore, 
                        latestRecord.totalSleep, 
                        latestRecord.awakeTime, 
                        latestRecord.remSleep
                    );
                    
                    // Show results
                    document.getElementById('noResultsContent').classList.add('hidden');
                    document.getElementById('resultsContent').classList.remove('hidden');
                    
                    // Update sleep phases chart
                    updateSleepPhasesChart(
                        latestRecord.awakeTime,
                        latestRecord.remSleep,
                        latestRecord.lightSleep,
                        latestRecord.deepSleep
                    );
                }
                
                // Save the imported data
                saveData();
                
                showNotification("Import Successful", "Your data has been imported successfully!");
                return true;
            } catch (error) {
                console.error("Failed to import data:", error);
                showNotification("Import Failed", "The data format is invalid or corrupted.");
                return false;
            }
        }
        
        function resetAllData() {
            // Reset all game state
            sleepRecords = [];
            totalBloodEchoes = 0;
            totalInsight = 0;
            currentHunterRank = 0;
            bossesDefeated = [];
            currentBossId = null;
            currentBossData = null;
            currentBossProgress = 0;
            currentBossTarget = 5;
            currentSeasonalEvent = null;
            runeLevels = {};
            
            // Reset UI elements
            document.querySelectorAll('.rune').forEach(rune => {
                rune.classList.remove('unlocked');
                const level = rune.querySelector('.rune-level');
                if (level) level.remove();
            });
            
            document.querySelectorAll('.achievement').forEach(chalice => {
                chalice.classList.remove('unlocked');
            });
            
            // Reset boss UI
            document.getElementById('bossName').innerHTML = "...";
            document.getElementById('bossDescription').textContent = "...";
            updateBossProgress();
            updateBossTrophies();
            
            // Reset hunter rank
            document.getElementById('hunterRank').textContent = "Waking Hunter I";
            document.getElementById('totalBloodEchoes').textContent = "0";
            document.getElementById('totalInsight').textContent = "0";
            document.getElementById('currentRank').textContent = "Waking Hunter I";
            document.getElementById('nextRank').textContent = "Waking Hunter II";
            document.getElementById('rankProgressBar').style.width = "0%";
            document.getElementById('rankProgressText').textContent = "0 / 100,000 Blood Echoes";
            
            // Reset achievement counts
            document.getElementById('runesUnlockedCount').textContent = "0/7";
            document.getElementById('chalicesUnlockedCount').textContent = "0/7";
            
            // Reset progress circles
            document.querySelectorAll('.progress-circle').forEach(circle => {
                circle.style.background = "conic-gradient(var(--primary-color) 0%, #2c2c2c 0%)";
            });
            
            // Hide seasonal banner
            document.getElementById('seasonalBanner').style.display = 'none';
            
            // Hide results content
            document.getElementById('resultsContent').classList.add('hidden');
            document.getElementById('noResultsContent').classList.remove('hidden');
            
            // Reset sleep phase chart if it exists
            if (sleepPhasesChart) {
                sleepPhasesChart.destroy();
                sleepPhasesChart = null;
            }
            
            // Reset history table
            const historyTableBody = document.getElementById('historyTableBody');
            if (historyTableBody) {
                historyTableBody.innerHTML = '';
            }
            
            // Reset boss trophy container
            const bossTrophyContainer = document.getElementById('bossTrophyContainer');
            if (bossTrophyContainer) {
                bossTrophyContainer.innerHTML = '';
            }
            
            // Reset charts
            if (weeklyScoreChart) {
                weeklyScoreChart.destroy();
                weeklyScoreChart = null;
            }
            
            if (sleepConsistencyChart) {
                sleepConsistencyChart.destroy();
                sleepConsistencyChart = null;
            }
            
            // Clear localStorage completely
            localStorage.clear();
        }
        
        // UI Event Handlers
        
        // Manual save buttons
        document.getElementById('manualSaveBtn').addEventListener('click', function() {
            if (saveData()) {
                showNotification("Save Successful", "Your progress has been saved successfully!");
            } else {
                showNotification("Save Failed", "Failed to save your progress. Please try again.");
            }
        });
        
        document.getElementById('settingsSaveBtn').addEventListener('click', function() {
            if (saveData()) {
                showNotification("Save Successful", "Your progress has been saved successfully!");
            } else {
                showNotification("Save Failed", "Failed to save your progress. Please try again.");
            }
        });
        
        // Export data button
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            const gameData = {
                sleepRecords: sleepRecords,
                totalBloodEchoes: totalBloodEchoes,
                totalInsight: totalInsight,
                currentHunterRank: currentHunterRank,
                bossesDefeated: bossesDefeated,
                currentBossId: currentBossId,
                currentBossData: currentBossData,
                currentBossProgress: currentBossProgress,
                currentBossTarget: currentBossTarget,
                currentSeasonalEvent: currentSeasonalEvent,
                runeLevels: runeLevels,
                unlockedRunes: Array.from(document.querySelectorAll('.rune.unlocked')).map(rune => rune.id),
                unlockedChalices: Array.from(document.querySelectorAll('.achievement.unlocked')).map(chalice => chalice.id),
                exportVersion: "1.4.0",
                exportDate: new Date().toISOString()
            };
            
            document.getElementById('exportDataText').value = JSON.stringify(gameData);
            document.getElementById('exportModal').classList.add('active');
        });
        
        // Copy export data button
        document.getElementById('copyExportBtn').addEventListener('click', function() {
            const exportText = document.getElementById('exportDataText');
            exportText.select();
            
            try {
                navigator.clipboard.writeText(exportText.value);
                showNotification("Copy Successful", "Data copied to clipboard!");
            } catch (err) {
                document.execCommand('copy');
                showNotification("Copy Successful", "Data copied to clipboard!");
            }
        });
        
        // Import data button
        document.getElementById('importDataBtn').addEventListener('click', function() {
            const importDataValue = document.getElementById('importData').value.trim();
            
            if (!importDataValue) {
                showNotification("Import Failed", "Please paste exported data in the text area.");
                return;
            }
            
            try {
                // Just parse to validate it's valid JSON
                JSON.parse(importDataValue);
                
                // Confirm the import
                if (confirm("Are you sure you want to import this data? Your current progress will be replaced.")) {
                    // Process the imported data
                    if (processImportedData(importDataValue)) {
                        document.getElementById('importData').value = '';
                    }
                }
            } catch (error) {
                showNotification("Import Failed", "The data format is invalid or corrupted.");
            }
        });
        
        // Reset progress button
        document.getElementById('resetProgressBtn').addEventListener('click', function() {
            document.getElementById('resetConfirmModal').classList.add('active');
        });
        
        // Confirm reset button
        document.getElementById('confirmResetBtn').addEventListener('click', function() {
            resetAllData();
            
            // Re-initialize with fresh empty data
            initializeDemoData();
            
            // Close modal
            document.getElementById('resetConfirmModal').classList.remove('active');
            
            // Update UI to show reset
            updateHunterRank();
            updateBossProgress();
            updateBossTrophies();
            updateSeasonalEvent();
            
            // Initialize charts with fresh data if we're on the history tab
            if (document.getElementById('historyView').classList.contains('hidden') === false) {
                initializeHistoryCharts();
                populateHistoryTable();
            }
            
            // Show notification
            showNotification("Reset Complete", "Your progress has been reset.");
        });
        
        // Cancel reset button
        document.getElementById('cancelResetBtn').addEventListener('click', function() {
            document.getElementById('resetConfirmModal').classList.remove('active');
        });
        
        // Delete record handlers
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            if (date) {
                deleteRecord(date);
                document.getElementById('deleteRecordModal').classList.remove('active');
            }
        });
        
        document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
            document.getElementById('deleteRecordModal').classList.remove('active');
        });
        
        document.getElementById('deleteRecordModalClose').addEventListener('click', function() {
            document.getElementById('deleteRecordModal').classList.remove('active');
        });
        
        // How to play button
        document.getElementById('howToPlayBtn').addEventListener('click', function() {
            document.getElementById('howToPlayModal').classList.add('active');
        });
        
        // Close how to play modal
        document.getElementById('closeHowToPlayBtn').addEventListener('click', function() {
            document.getElementById('howToPlayModal').classList.remove('active');
        });
        
        // Accept new boss button
        document.getElementById('acceptBossBtn').addEventListener('click', function() {
            document.getElementById('newBossModal').classList.remove('active');
        });
        
        // Modal close buttons
        document.getElementById('resetModalClose').addEventListener('click', function() {
            document.getElementById('resetConfirmModal').classList.remove('active');
        });
        
        document.getElementById('exportModalClose').addEventListener('click', function() {
            document.getElementById('exportModal').classList.remove('active');
        });
        
        document.getElementById('howToPlayModalClose').addEventListener('click', function() {
            document.getElementById('howToPlayModal').classList.remove('active');
        });
        
        document.getElementById('newBossModalClose').addEventListener('click', function() {
            document.getElementById('newBossModal').classList.remove('active');
        });
        
        // Theme selection
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'dark') {
                    document.body.classList.add('dark');
                } else if (this.value === 'light') {
                    document.body.classList.remove('dark');
                } else if (this.value === 'system') {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                }
            });
        });
        
        // Initialize with first rune selected
        document.getElementById('rune-moon').click();
    </script>
</body>
</html>